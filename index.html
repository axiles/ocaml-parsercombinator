<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
<meta name="generator" content="AsciiDoc 8.6.10" />
<title>Resumable Parser Combinators with error detection</title>
<style type="text/css">
/*
 * AsciiDoc 'volnitsky' theme for xhtml11 and html5 backends.
 * Based on css from http://volnitsky.com, which was in turn based on default
 * theme from AsciiDoc
 *
 * FIXME: The styling is still a bit rough in places.
 *
 */

/* Default font. */
body {
  font-family: Georgia,"Times New Roman",Times,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Candara,Arial,sans-serif;
}


#toc a {
    border-bottom: 1px dotted #999999;
    color: #3A3A4D !important;
    text-decoration: none !important;
}
#toc a:hover {
    border-bottom: 1px solid #6D4100;
    color: #6D4100 !important;
    text-decoration: none !important;
}
a { color: #666688; text-decoration: none; border-bottom: 1px dotted #666688; }
a:visited { color: #615FA0; border-bottom: 1px dotted #615FA0; }
a:hover { color: #6D4100; border-bottom: 1px solid #6D4100; }

em {
  font-style: italic;
  color: #444466;
}

strong {
  font-weight: bold;
  color: #444466;
}

h1, h2, h3, h4, h5, h6 {
  color: #666688;
  margin-bottom: 0.5em;
  line-height: 1.3;
  letter-spacing:+0.15em;
}

h1, h2, h3 { border-bottom: 2px solid #ccd; }
h2 { padding-top: 0.5em; }
h3 { float: left; }
h3 + * { clear: left; }

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid #444466;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #444466;
  font-weight: bold;
  font-size: 1.1em;
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}

#footer-text {
  float: left;
  padding-bottom: 0.5em;
}

#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}

div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}

div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #444466;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock {
  padding-left: 2.0em;
  margin-right: 10%;
}
div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock {
  padding-left: 2.0em;
  margin-right: 10%;
}
div.verseblock > pre.content {
  font-family: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #444466;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: #444466;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

div.tableblock > table {
  border: 3px solid #444466;
}
thead {
  font-weight: bold;
  color: #444466;
}
tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: #444466;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

@media print {
  #footer-badges { display: none; }
}

#toctitle {
  color: #666688;
  font-size: 1.2em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 { margin-top: 0; margin-bottom: 0; }
div.toclevel1 { margin-top: 0.3em; margin-left: 0; font-size: 1.0em; }
div.toclevel2 { margin-top: 0.25em; margin-left: 2em; font-size: 0.9em; }
div.toclevel3 { margin-left: 4em; font-size: 0.8em; }
div.toclevel4 { margin-left: 6em; font-size: 0.8em; }

body {
  margin: 1em 5%;
  max-width:  55em;
  padding-left: 0;

}

.monospaced, tt, div.listingblock > div.content {
  font-family:  Consolas, "Andale Mono", "Courier New", monospace;
  color: #004400;
  background: #f4f4f4;
  max-width: 80em;
  line-height: 1.2em;
}

.paragraph p  {
  line-height: 1.5em;
  margin-top: 1em;
}

.paragraph p, li, dd, .content { max-width: 45em; }
.admonitionblock               { max-width: 35em; }

div.sectionbody div.ulist > ul > li {
  list-style-type: square;
  color: #aaa;
}
  div.sectionbody div.ulist >  ul > li > * {
    color: black;
    /*font-size: 50%;*/
  }


div.sectionbody div.ulist > ul > li div.ulist > ul > li {
  color: #ccd ;
}
  div.sectionbody div.ulist > ul > li div.ulist > ul > li > * {
    color: black ;
  }

em {
  font-style: normal ! important;
  font-weight: bold ! important;
  color: #662222   ! important;
  letter-spacing:+0.08em ! important;
}

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #666688;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #444466;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #444466;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}




</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article" style="max-width:55em">
<div id="header">
<h1>Resumable Parser Combinators with error detection</h1>
<span id="author">rixed@happyleptic.org</span><br />
<span id="revnumber">version 0.1,</span>
<span id="revdate">2015-10-27</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_what_is_this">1. What is this?</h2>
<div class="sectionbody">
<div class="paragraph"><p>This document describes the implementation of a library performing text
parsing according to a technique that is called
<a href="https://en.wikipedia.org/wiki/Parser_combinator">parser combinators</a> because the
parser for a given grammar is build by combining simpler parsers. This technique
is fashionable although old and slow for the reason that it is simple and
permissive.</p></div>
<div class="paragraph"><p>This is also an example of literate programming; in case the notations used in
this document are unclear you can read about them in
<a href="http://rixed.github.io/portia/notations.html">this document</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_requirements">2. Requirements</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_a_n_1_sup_th_sup_parser_to_rule_them_all">2.1. A N+1<sup>th</sup> parser to rule them all</h3>
<div class="paragraph"><p>Along the years I&#8217;ve often written small dedicated parsing libraries, either
using lex+yacc approach for well behaved syntaxes or custom made combinatoric
parsers because they are fun to play with and more flexible. My needs ranged
from parsing configuration files, parsing programming languages, parsing
natural languages, parsing networking protocols&#8230;</p></div>
<div class="paragraph"><p>This parser is meant to be flexible enough to accommodate all those needs, when
speed is not an issue.</p></div>
</div>
<div class="sect2">
<h3 id="_parsing_binary">2.2. Parsing binary</h3>
<div class="paragraph"><p>Although most of the times one wants to parse text, there are cases when the
need arises to parse binary messages (such as when parsing some networking
protocols). Therefore parsed input tokens must not be bound to characters.</p></div>
</div>
<div class="sect2">
<h3 id="_parsing_recursively">2.3. Parsing recursively</h3>
<div class="paragraph"><p>I want to parse as much as possible from perl and other such footgun languages
(without executing them).  Perl has <code>eval</code> on strings. Therefore parsing must
not stop as soon as we reach a string literal but instead recurse and try to
parse that string. It must therefore be possible to write such a recursive set
of rules.</p></div>
</div>
<div class="sect2">
<h3 id="_parsing_with_gaps">2.4. Parsing with gaps</h3>
<div class="paragraph"><p>For the same reason I want to be able to parse as much as possible of an input
even if some parts of it is (still) missing. This is useful both to parse
string fragments into code but also to parse a networking stream despite
missing packets.</p></div>
</div>
<div class="sect2">
<h3 id="_best_effort">2.5. Best effort</h3>
<div class="paragraph"><p>It will not always be possible to know for sure the type of all symbols. In
that case we want to present all possible alternatives as the result, rather
than stopping the parse or selecting the most probable one.</p></div>
</div>
<div class="sect2">
<h3 id="_resumable_parsers">2.6. Resumable parsers</h3>
<div class="paragraph"><p>The parser must be usable for parsing large messages either received from
the network or stored on a file, without having to buffer everything.  Input
tokens must therefore be consumed as they arrive, and the parser must "return"
when it has processed the given input as much as possible, and be resumable
later on when more data is available.</p></div>
<div class="paragraph"><p>For this, <code>call_cc</code> would help tremendously to freeze the state of affairs and
return it to the original caller.  Without that facility, though, alternatives
do exist:</p></div>
<div class="paragraph"><p>A conventional method to achieve something similar is to turn our API (aka our
types) inside out: instead of taking a stream of input tokens and returning a
result, parsers could take the next item and return, along with each result, a
next-step parser to apply to the next token. This is rather inconvenient,
though.</p></div>
<div class="paragraph"><p>Alternatively, threading is another way to freeze ones stack: a parser waiting
for input could just be waiting for a conditional variable, or the input stream
could be a <code>mailbox variable</code> kind of queue, etc. All this amount to relying on
the operating to freeze the parser and resume it later.</p></div>
<div class="paragraph"><p>We might want to use those parsers in an environment where using POSIX threads
is not an option, though (such as: in a microkernel).  In that case lightweight
threads (akin to gnupth) could work, but that&#8217;s still a huge constraint on the
environment. Instead, closure-based threads, a variety of cooperative threads
where a thread context is saved in a function closure (and that are also
sometime referred to as "lightweight threads") are cheap and does not depend on
OS support ; for this reason they are available in many shapes and forms. The
downside is that the API needs to accommodate for those (basically, each parser
must return a future value rather than a value). But once this abstraction is
in place then one is free to use it for any variant of threads or make it a
bypass. That&#8217;s thus what this library will be using, at the cost of a bit of
functorization.</p></div>
</div>
<div class="sect2">
<h3 id="_error_detection">2.7. Error detection</h3>
<div class="paragraph"><p>Error detection must be an option. The simplest method to reach this goal would
be to have an <em>error budget</em>, and try different outcomes at every step to look
the combination of alternatives that parse the most of the input stream.</p></div>
<div class="paragraph"><p>It is hard to make this technique less awfully expensive than it sounds.</p></div>
<div class="paragraph"><p>Setting this error budget to zero would effectively turn off the feature.</p></div>
<div class="paragraph"><p>Instead of a global error budget, one may prefer to have a maximum error rate.</p></div>
<div class="paragraph"><p>Many of those ideas come from
<a href="http://www.staff.science.uu.nl/~swier101/Papers/1999/SofSem99.pdf">Fast, Error
Correcting Parser Combinators: A Short Tutorial</a>, a XX<sup>th</sup> century paper.</p></div>
</div>
<div class="sect2">
<h3 id="_error_reporting">2.8. Error reporting</h3>
<div class="paragraph"><p>Although this is related to error detection, error reporting is a requirement
on its own.  Indeed, a parser could do a good job at correcting typos but still
be unable to report a meaningful error message when it fails to process the
input tokens.</p></div>
</div>
<div class="sect2">
<h3 id="_parser_combinators">2.9. Parser Combinators</h3>
<div class="paragraph"><p>Natural languages (and many runtime typed programming languages too) do not bow
to any rigid formal grammar. Parser combinators are appealing because they make
it possible to add new valid constructs without rethinking the whole grammar;
thus permitting to build a good enough parser iteratively.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_type_of_the_parser">3. The type of the parser</h2>
<div class="sectionbody">
<div class="paragraph"><p>To be clearer, let&#8217;s write down the usual type of a parser used with
combinators, written in ML:</p></div>
<div class="listingblock">
<div class="title">Typical parser type</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #990000">(</span>'a<span style="color: #990000">,</span> 'b<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">parser</span></span> <span style="color: #990000">=</span> 'a <span style="color: #009900">list</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #990000">*</span> 'a <span style="color: #009900">list</span><span style="color: #990000">)</span> <span style="color: #009900">list</span></tt></pre></div></div>
<div class="paragraph"><p>Which reads like this: Calling α (<code>'a</code>) the type of the input tokens and β
(<code>'b</code>) the type of the result, a parser is a function that takes a list of α
and returns a list of pairs composed of a β and a list of α, being the list
of all possible solutions, composed of the result of parsing and the list of
tokens that remain to be parsed.</p></div>
<div class="paragraph"><p>Ideally, a successful top level parser will thus return a list composed of a
single pair (non ambiguity of the outcome) made of the final result and an
empty list (the whole input has been consumed).</p></div>
<div class="paragraph"><p>For resumable parsing in a possibly threading context we need to
introduce the <code>α ct</code> type (for a future value of type <code>α</code>), and make the
input stream of tokens a possibly blocking function returning the next item,
also turning our <code>Parsers</code> module into a functor depending on what mechanism we
plan to use for threading between parsers and token intake.</p></div>
<div class="paragraph"><p>Having now a functor and an abstract stream brings the question whether to keep
the type for tokens (α) universal or rather make it existential (an abstract
but single type). Keeping it universal makes it easier to combine parsers
(especially: we can devise such combinators that feed a parser with something
else than tokens, such as the result of another parser). But on the down side
it would force the user to hand us a stream type that can handle any type,
which is a strong constraint to bear with ; for one, it prevents the stream
implementation to look at the actual values. This would prove too inconvenient
given we will enrich the stream with positions. We thus change the type of the
stream to return an existential rather than universal type:</p></div>
<div class="listingblock">
<div class="title">Parsers.ml: functor to parametrize over the threading mechanism</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>

<span style="font-style: italic"><span style="color: #9A1900">(* ...Parsers helpers... *)</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">CONFIG</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">sig</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token
  <span style="font-style: italic"><span style="color: #9A1900">(* ...Parser configuration... *)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">S</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">sig</span></span>
  <span style="font-weight: bold"><span style="color: #000080">include</span></span> <span style="color: #009900">CONFIG</span>

  <span style="font-style: italic"><span style="color: #9A1900">(* ...Parser signature... *)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">Make</span> <span style="color: #990000">(</span><span style="color: #009900">Conf</span> <span style="color: #990000">:</span> <span style="color: #009900">CONFIG</span><span style="color: #990000">)</span> <span style="color: #990000">:</span>
  <span style="color: #009900">S</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>token
  <span style="font-style: italic"><span style="color: #9A1900">(* ...parser public type constraints... *)</span></span> <span style="color: #990000">=</span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
  <span style="font-weight: bold"><span style="color: #000080">include</span></span> <span style="color: #009900">Conf</span>

  <span style="font-style: italic"><span style="color: #9A1900">(* ...Parser library... *)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Due to functorization we have to explicitly provide a signature for the
result of <code>Make</code> so that we can use the resulting parser as input of further
functors.</p></div>
<div class="paragraph"><p>The configuration must thus provide not only the actual type for frozen
computations (aka future values) but also a way to wrap a value into such a
<code>future value</code> and a way to pipe one <code>thread</code> into another, both operations
typically called <code>return</code> and <code>bind</code> but here prefixed with <code>ct_</code> because we
reserve those names for parser combinators:</p></div>
<div class="listingblock">
<div class="title">threading types</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> ct_return <span style="color: #990000">:</span> 'a <span style="color: #990000">-&gt;</span> 'a ct
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> ct_bind <span style="color: #990000">:</span> 'a ct <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'a <span style="color: #990000">-&gt;</span> 'b ct<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> 'b ct</tt></pre></div></div>
<div class="paragraph"><p>Thus the possibly blocking input mechanism:</p></div>
<div class="listingblock">
<div class="title">Parser configuration with possible threading</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">(* ...threading types... *)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> stream
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> take <span style="color: #990000">:</span> stream <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>token <span style="font-weight: bold"><span style="color: #000080">ParsersMisc</span></span><span style="color: #990000">.</span>stream_item <span style="color: #990000">*</span> stream<span style="color: #990000">)</span> ct</tt></pre></div></div>
<div class="paragraph"><p>With the <code>stream_item</code> type being like an <code>option</code> type with more specific
constructors, defined in a separate module for fear of circular dependencies:</p></div>
<div class="listingblock">
<div class="title">ParsersMisc.ml: type of stream value</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a stream_item <span style="color: #990000">=</span> <span style="color: #009900">Item</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> 'a <span style="color: #990000">|</span> <span style="color: #009900">EndOfStream</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that this <code>stream</code> container must be free of side effects to the extend
that any token read from it in one place must still be available for reading
from previously stored streams. That is why <code>take</code> returns both the next token
and the next (shorter) stream. In other words it must be a persistent data
structure.</p></div>
<div class="paragraph"><p>For convenience better not keep it secret where our <code>Parsers</code> take their types
from:</p></div>
<div class="listingblock">
<div class="title">parser public type constraints</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>ct</tt></pre></div></div>
<div class="paragraph"><p>Thus a parser now has this shape:</p></div>
<div class="listingblock">
<div class="title">Resumable parser type</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'b <span style="font-weight: bold"><span style="color: #0000FF">parser</span></span> <span style="color: #990000">=</span> stream <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #990000">*</span> stream<span style="color: #990000">)</span> <span style="color: #009900">list</span> ct</tt></pre></div></div>
<div class="paragraph"><p>With this API, when the parser fails to find any way to parse the input it
returns a minimally informative empty list. Introducing the error budget
changes this somewhat: we will try to artificially force the failing parsers to
succeed in order to sneak into that alternate reality and try to locate where a
change would lead to a drastically better outcome. This means that each
individual result must be accompanied with a description of the (few) changes
required to reach that point:</p></div>
<div class="listingblock">
<div class="title">Parser type with error detection</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'b <span style="font-weight: bold"><span style="color: #0000FF">parser</span></span> <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #000080">ParsersCorrections</span></span><span style="color: #990000">.</span>t <span style="color: #990000">-&gt;</span> stream <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000080">ParsersCorrections</span></span><span style="color: #990000">.</span>t <span style="color: #990000">*</span> stream<span style="color: #990000">)</span> <span style="color: #009900">list</span> ct</tt></pre></div></div>
<div class="paragraph"><p>Before taking a closer look at this new <code>ParsersCorrections.t</code> type that would
encode the corrections we must question the usage of a list of results as the
return type.  Firstly, a list is over-specified since the order of the possible
results is not important; what we really want here is a set and we use a list
only because it makes our code more terse. More importantly an empty list to
signal failure seems not enough to explore the artificial <em>failure</em> of parsers
(because we need to store that correction somewhere).</p></div>
<div class="paragraph"><p>Consider for instance this excerpt from a fictitious programming language:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>class form;
for x = new form(...);</code></pre>
</div></div>
<div class="paragraph"><p>Obviously the intent was to write <code>form x = &#8230;</code>. Imagine the rule to parse the
second line is <code>is_keyword XOR is_name</code>. Once the parser have accepted the
keyword <code>for</code> as valid without questioning it then it is likely that the error
message pointing at what follows will be hard to comprehend. On another hand, if
the parser also tried to force the failure of the keyword parser in this
location then it will notice that everything would parse properly henceforth,
suggesting a better error message. So it seems beneficial to return that
failure as a correction and move on to next token.</p></div>
<div class="paragraph"><p>The price to pay for testing the failure of successful parsers is obviously
high, though, and not only because of the additional time spent. Returning
error descriptions alongside failures forces us to give up the elegant list of
result as the main return type.</p></div>
<div class="paragraph"><p>But it seems that this problem arises only when we make use of the exclusive
alternative.  Should we decide not to implement such a combinator, then the
above example &#8220;either a keyword or a variable name that is not a keyword&#8221;
could still be written with inclusive alternative at the price of redundant
checks: <code>(is_keyword AND (check (NOT is_name))) OR (is_name AND (check (NOT
is_keyword)))</code>. In this case we could explore the failure of the checks and
notice that if <code>for</code> were a valid variable name then the input would be valid,
which will make a much better error message.</p></div>
<div class="paragraph"><p>So we will not implement exclusive alternative and will instead explore forced
success of the <code>check</code> parser. Hence, we turned exploring failure into
exploring success and saved our list as the return type.</p></div>
<div class="paragraph"><p>Now, what&#8217;s this <code>ParsersCorrections.t</code> type?</p></div>
<div class="paragraph"><p>To be able to build a useful error message we must point at the position in
the original stream of tokens where some change had to be made in order to
parse the input stream of tokens (if not in full at least more than without
that change). What constitutes a position depends on the nature of the tokens.
The obvious offset since the beginning might not always be appropriate and
it&#8217;s probably better to leave it open to the user. Let&#8217;s therefore assume that
both tokens and positions are read from the input stream.</p></div>
<div class="paragraph"><p>In addition to the location a mere description of the parser that we forced
to succeed (as a string) completes the <code>ParsersCorrection.t</code>:</p></div>
<div class="listingblock">
<div class="title">ParsersCorrections.ml: type</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">ParsersMisc</span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #990000">(</span>'pos<span style="color: #990000">,</span> 'tok<span style="color: #990000">)</span> t <span style="color: #990000">=</span> <span style="color: #990000">(</span>'pos <span style="color: #990000">*</span> 'tok stream_item <span style="color: #990000">*</span> <span style="color: #009900">string</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>t</tt></pre></div></div>
<div class="paragraph"><p>where <code>ParsersBoundedSet</code> is an unordered container with a maximum capacity (the
maximum amount of changes allowed) and which API will become clearer as we
encounter the few required functions.</p></div>
<div class="paragraph"><p>Trivially, to add an error at a given position to the correction list, with
message <code>m</code>:</p></div>
<div class="listingblock">
<div class="title">ParsersCorrections.ml: recording a change</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> change_at c pos tok m <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>add c <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> tok<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>hd m<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Now that we know what corrections look like and that we have to read the
positions alongside the tokens from the input stream, we can write a better
type for the parser:</p></div>
<div class="listingblock">
<div class="title">Parser type with error correction</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'b possible_result <span style="color: #990000">=</span>
  'b <span style="color: #990000">*</span> <span style="color: #990000">((</span>position<span style="color: #990000">,</span> token<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000080">ParsersCorrections</span></span><span style="color: #990000">.</span>t<span style="color: #990000">)</span> <span style="color: #990000">*</span> stream
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'b t <span style="color: #990000">=</span>
  <span style="color: #990000">(</span>position <span style="color: #990000">*</span> token<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000080">ParsersCorrections</span></span><span style="color: #990000">.</span>t <span style="color: #990000">-&gt;</span> stream <span style="color: #990000">-&gt;</span>
  'b possible_result <span style="color: #009900">list</span> ct</tt></pre></div></div>
<div class="paragraph"><p>The type <code>position</code> have to be supplied by the functor configuration and now we
have the final type for <code>stream</code>/<code>take</code>:</p></div>
<div class="listingblock">
<div class="title">Parser configuration: now also supplying position</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">(* ...threading types... *)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> position
<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> stream
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> take <span style="color: #990000">:</span> stream <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>position <span style="color: #990000">*</span> token <span style="font-weight: bold"><span style="color: #000080">ParsersMisc</span></span><span style="color: #990000">.</span>stream_item <span style="color: #990000">*</span> stream<span style="color: #990000">)</span> ct</tt></pre></div></div>
<div class="listingblock">
<div class="title">parser public type constraints</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> position <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>position
<span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> stream <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>stream</tt></pre></div></div>
<div class="paragraph"><p>We are not done yet. Above we saved the list as a container for the possible
solutions, but this still left us with an empty list when no solution could be
found, from which it&#8217;s not possible to devise an informative error message!</p></div>
<div class="paragraph"><p>In addition to the cumulative list of all solutions a parser should also return
an aggregated value containing the "best" error found.</p></div>
<div class="paragraph"><p>What we call the "best" error is the error that caused the parser to give up
(return <code>[]</code>) the later in the input stream, measured by the position of the
token. We thus need a comparison function between two positions. We could have
a minimally informative <code>greater_than : position &#8594; position &#8594; bool</code> function,
but it will be later convenient to have an idea of the actual (oriented)
distance between any two positions, to let&#8217;s rather define:</p></div>
<div class="listingblock">
<div class="title">Parser configuration: comparator for positions</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> distance <span style="color: #990000">:</span> position <span style="color: #990000">-&gt;</span> position <span style="color: #990000">-&gt;</span> <span style="color: #009900">int</span></tt></pre></div></div>
<div class="paragraph"><p>An error is composed of the location in the stream where the parsing stopped
and the stack of things the parser was trying to build:</p></div>
<div class="listingblock">
<div class="title">error type:</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> error <span style="color: #990000">=</span>
  <span style="color: #FF0000">{</span> where <span style="color: #990000">:</span> position <span style="color: #990000">;</span> what <span style="color: #990000">:</span> <span style="color: #009900">string</span> <span style="color: #009900">list</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>We can update the current best error from another stream item and stack of
messages with this simple function:</p></div>
<div class="listingblock">
<div class="title">keeping track of the best error</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> new_error where what <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span>
    <span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> where <span style="color: #990000">;</span> what <span style="color: #FF0000">}</span>
  <span style="color: #990000">|</span> <span style="color: #009900">Some</span> err <span style="font-weight: bold"><span style="color: #0000FF">as</span></span> e <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> distance err<span style="color: #990000">.</span>where where <span style="color: #990000">&gt;=</span> <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
      <span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> where <span style="color: #990000">;</span> what <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
      e</tt></pre></div></div>
<div class="paragraph"><p>With the idea that a stack of messages describing the context is maintained
from one parser to the next as the context gets deeper. Therefore, every parser
must accept this current stack as an additional input and enrich it with
whatever makes sense (which oftentimes requires some hint from the caller).</p></div>
<div class="paragraph"><p>So that the new (and final) type for parsers expands to:</p></div>
<div class="listingblock">
<div class="title">final parser type</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">(* ...error type... *)</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'b possible_result <span style="color: #990000">=</span>
  'b <span style="color: #990000">*</span> <span style="color: #990000">((</span>position<span style="color: #990000">,</span> token<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000080">ParsersCorrections</span></span><span style="color: #990000">.</span>t<span style="color: #990000">)</span> <span style="color: #990000">*</span> stream

<span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'b t <span style="color: #990000">=</span>
  <span style="color: #009900">string</span> <span style="color: #009900">list</span> <span style="color: #990000">-&gt;</span> error <span style="color: #009900">option</span> <span style="color: #990000">-&gt;</span>
  <span style="color: #990000">(</span>position<span style="color: #990000">,</span> token<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000080">ParsersCorrections</span></span><span style="color: #990000">.</span>t <span style="color: #990000">-&gt;</span> stream <span style="color: #990000">-&gt;</span>
  <span style="color: #990000">(</span>error <span style="color: #009900">option</span> <span style="color: #990000">*</span> 'b possible_result <span style="color: #009900">list</span><span style="color: #990000">)</span> ct</tt></pre></div></div>
<div class="paragraph"><p>That we want both in the implementation and the signature:</p></div>
<div class="listingblock">
<div class="title">Parser library</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">(* ...final parser type... *)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">(* ...keeping track of the best error... *)</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">(* ...final parser type... *)</span></span></tt></pre></div></div>
<div class="paragraph"><p>That&#8217;s a lot of inputs. For simplicity and conciseness those parameters will
always be given the same one letter names:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>m</code> for the stack of messages describing the context (of type <code>string list</code>);
</p>
</li>
<li>
<p>
<code>e</code> for the optional <code>error</code>;
</p>
</li>
<li>
<p>
<code>c</code> for the <code>ParsersCorrections.t</code>;
</p>
</li>
<li>
<p>
<code>s</code> for the <code>stream</code>;
</p>
</li>
<li>
<p>
<code>x</code> for a <code>token</code>;
</p>
</li>
<li>
<p>
<code>p</code> for a parser (of type <code>t</code>);
</p>
</li>
<li>
<p>
<code>r</code> for a list or possible results (of type <code>'b possible_result list</code>).
</p>
</li>
</ul></div>
<div class="paragraph"><p>The output itself, <code>(error option * 'b possible_result list) ct</code> suits
combining parsers but may be a bit of a mouthful for the end user to chew. This
function turns it into a more edible <code>result</code> type:</p></div>
<div class="listingblock">
<div class="title">Parser library: building a final result from possible results</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> to_result x <span style="color: #990000">=</span>
  ct_bind x <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e<span style="color: #990000">,</span> r<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
    <span style="font-style: italic"><span style="color: #9A1900">(* If we have a single solution then that's the one! *)</span></span>
    ct_return <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">match</span></span> r <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
    <span style="color: #990000">|</span> <span style="color: #990000">[</span> b<span style="color: #990000">,</span> c<span style="color: #990000">,</span> s <span style="color: #990000">]</span> <span style="color: #990000">-&gt;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>is_empty c <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="color: #009900">Ok</span> <span style="color: #990000">(</span>b<span style="color: #990000">,</span> s<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #009900">Bad</span> <span style="color: #990000">(</span><span style="color: #009900">Approximation</span> <span style="color: #990000">(</span>b<span style="color: #990000">,</span> c<span style="color: #990000">,</span> s<span style="color: #990000">))</span>
    <span style="color: #990000">|</span> <span style="color: #990000">[]</span> <span style="color: #990000">-&gt;</span>
      <span style="color: #009900">Bad</span> <span style="color: #990000">(</span><span style="color: #009900">NoSolution</span> e<span style="color: #990000">)</span>
    <span style="color: #990000">|</span> lst <span style="color: #990000">-&gt;</span>
      <span style="color: #009900">Bad</span> <span style="color: #990000">(</span><span style="color: #009900">Ambiguous</span> lst<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>of type:</p></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> to_result <span style="color: #990000">:</span> <span style="color: #990000">(</span>error <span style="color: #009900">option</span> <span style="color: #990000">*</span> 'b possible_result <span style="color: #009900">list</span><span style="color: #990000">)</span> ct <span style="color: #990000">-&gt;</span>
                <span style="color: #990000">(</span>'b <span style="color: #990000">*</span> stream<span style="color: #990000">,</span> 'b failure<span style="color: #990000">)</span> result ct</tt></pre></div></div>
<div class="paragraph"><p>with:</p></div>
<div class="listingblock">
<div class="title">final parser type: many ways to fail</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'b failure <span style="color: #990000">=</span>
  <span style="color: #990000">|</span> <span style="color: #009900">Approximation</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #990000">(</span>'b <span style="color: #990000">*</span> <span style="color: #990000">(</span>position<span style="color: #990000">,</span> token<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000080">ParsersCorrections</span></span><span style="color: #990000">.</span>t <span style="color: #990000">*</span> stream<span style="color: #990000">)</span>
  <span style="color: #990000">|</span> <span style="color: #009900">Ambiguous</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #990000">(</span>'b <span style="color: #990000">*</span> <span style="color: #990000">(</span>position<span style="color: #990000">,</span> token<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000080">ParsersCorrections</span></span><span style="color: #990000">.</span>t <span style="color: #990000">*</span> stream<span style="color: #990000">)</span> <span style="color: #009900">list</span>
  <span style="color: #990000">|</span> <span style="color: #009900">NoSolution</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> error <span style="color: #009900">option</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that we pay no attention to whether the stream has been emptied or not.
If one want to reach the end of the input stream then that must be part of the
parser (see <code>eof</code>).</p></div>
<div class="paragraph"><p>It will come handy to have a configuration that&#8217;s as simple as possible, with
no threading going on, for those cases where we do not need resumable parsers;
for instance when testing. Since there is no threading all the input has to be
already available and can thus be passed using a mere list.</p></div>
<div class="paragraph"><p>The <code>SimpleConfig</code> serves this purpose:</p></div>
<div class="listingblock">
<div class="title">Parsers.ml: simple configuration for non-resumable parsers</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">ParsersMisc</span>
<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">SimpleConfig</span>
  <span style="color: #990000">(</span><span style="color: #009900">Token</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">sig</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> t
    <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print <span style="color: #990000">:</span> 'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> t <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">)</span> <span style="color: #990000">=</span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Token</span></span><span style="color: #990000">.</span>t
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_token <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Token</span></span><span style="color: #990000">.</span>print
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> position <span style="color: #990000">=</span> <span style="color: #009900">int</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> distance p1 p2 <span style="color: #990000">=</span> p2 <span style="color: #990000">-</span> p1
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_position fmt p <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"offset %d"</span> p
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> stream <span style="color: #990000">=</span> position <span style="color: #990000">*</span> token <span style="color: #009900">list</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_stream fmt <span style="color: #990000">(</span>_<span style="color: #990000">,</span> s<span style="color: #990000">)</span> <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print print_token fmt s
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> take <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> <span style="color: #990000">[])</span> <span style="font-weight: bold"><span style="color: #0000FF">as</span></span> s <span style="color: #990000">-&gt;</span> pos<span style="color: #990000">,</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> s
    <span style="color: #990000">|</span> pos<span style="color: #990000">,</span> <span style="color: #990000">(</span>x<span style="color: #990000">::</span>rest<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> pos<span style="color: #990000">,</span> <span style="color: #009900">Item</span> x<span style="color: #990000">,</span> <span style="color: #990000">(</span>pos<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">,</span> rest<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_return x <span style="color: #990000">=</span> x
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_bind x f <span style="color: #990000">=</span> f x
  <span style="font-style: italic"><span style="color: #9A1900">(* ...other SimpleConfig definitions... *)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>We will devise a more elaborate configuration for <code>LWT</code> later on.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_base_parsers_to_be_combined">4. Base parsers (to be combined)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_fail_return_and_check">4.1. Fail, Return and check</h3>
<div class="paragraph"><p>The simplest parser that does nothing is <code>return</code>. It does not
consume anything from the input but merely return a single result:</p></div>
<div class="listingblock">
<div class="title">Parser library: return</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> return x _m e c s <span style="color: #990000">=</span> ct_return <span style="color: #990000">(</span>e<span style="color: #990000">,</span> <span style="color: #990000">[</span>x<span style="color: #990000">,</span> c<span style="color: #990000">,</span> s<span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>A similarly simple one is the parser that always fail:</p></div>
<div class="listingblock">
<div class="title">Parser library: fail</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> fail _m e _c _s <span style="color: #990000">=</span> ct_return <span style="color: #990000">(</span>e<span style="color: #990000">,</span> <span style="color: #990000">[])</span></tt></pre></div></div>
<div class="paragraph"><p>with signatures:</p></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> return <span style="color: #990000">:</span> 'b <span style="color: #990000">-&gt;</span> 'b t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> fail <span style="color: #990000">:</span> 'b t</tt></pre></div></div>
<div class="paragraph"><p>Those two first parsers perform no error correction at all.  But many other
parsers will have to either terminate parsing abruptly (with <code>fail</code>) or add a
change to the correction list and proceed, if the error budget is not
exhausted already. We will abstract this in a <code>fail_or_maybe_not</code> function:</p></div>
<div class="listingblock">
<div class="title">Parser library: fail with success exploration</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">ParsersCorrections</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> fail_or_maybe_not x <span style="font-style: italic"><span style="color: #9A1900">(* <img alt="1" src="data:image/png;base64,
iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAAAAABzHgM7AAAAAmJLR0QAAKqNIzIAAABjSURBVHja
VY6xDcAwCAS/pPQaLim9QmajdOk2I2SNrMEIlARIoigU8Cek/4e7zdHaWOYOVwaoA6wOCw05Y7FB
gE0tIWQ+sBcwKM8qoD/wB5wGL8hjfdzWrh01GRp1hInGjDoXwHgsFuzBVLQAAABDdEVYdFNvZnR3
YXJlAEAoIylJbWFnZU1hZ2ljayA0LjIuOCA5OS8wOC8wMSBjcmlzdHlAbXlzdGljLmVzLmR1cG9u
dC5jb22RuiG4AAAAKnRFWHRTaWduYXR1cmUANThhMDcyZTA3MGRhMjJmNjEzNWNiZDNlNDE0NTQ2
ZjloaiHtAAAADnRFWHRQYWdlADEyeDEyKzArMIRtu30AAAAASUVORK5CYII=" /> *)</span></span> m e c s <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>is_full c <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="color: #990000">(</span>
    <span style="font-style: italic"><span style="color: #9A1900">(* no more errors permitted so fail for real *)</span></span>
    ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> _<span style="color: #990000">,</span> _<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      fail m <span style="color: #990000">(</span>new_error pos m e<span style="color: #990000">)</span> c s<span style="color: #990000">)</span>
  <span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #990000">(</span>
    <span style="font-style: italic"><span style="color: #9A1900">(* Here we insert x in the stream ;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       Shall we also try to replace pos_tok with x?</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       In any case beware than s maybe end_of_stream.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       TODO: two types of correction: replace and insert *)</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">(* Note that corrections still count as errors because there is no</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       guarantee that we will keep track of them: *)</span></span>
    ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> tok<span style="color: #990000">,</span> _<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      return x m <span style="color: #990000">(</span>new_error pos m e<span style="color: #990000">)</span> <span style="color: #990000">(</span>change_at c pos tok m<span style="color: #990000">)</span> s<span style="color: #990000">))</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img alt="1" src="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAAAAABzHgM7AAAAAmJLR0QAAKqNIzIAAABjSURBVHja
VY6xDcAwCAS/pPQaLim9QmajdOk2I2SNrMEIlARIoigU8Cek/4e7zdHaWOYOVwaoA6wOCw05Y7FB
gE0tIWQ+sBcwKM8qoD/wB5wGL8hjfdzWrh01GRp1hInGjDoXwHgsFuzBVLQAAABDdEVYdFNvZnR3
YXJlAEAoIylJbWFnZU1hZ2ljayA0LjIuOCA5OS8wOC8wMSBjcmlzdHlAbXlzdGljLmVzLmR1cG9u
dC5jb22RuiG4AAAAKnRFWHRTaWduYXR1cmUANThhMDcyZTA3MGRhMjJmNjEzNWNiZDNlNDE0NTQ2
ZjloaiHtAAAADnRFWHRQYWdlADEyeDEyKzArMIRtu30AAAAASUVORK5CYII=" /></td><td>
Here we need an example value <code>x</code> of type β in order to change the outcome
of a failure. Which value exactly is not really a concern since only its type
matters (although the error message could print it as an example, as OCaml
compiler does when complaining about an incomplete pattern matching).
</td></tr>
</table></div>
<div class="paragraph"><p>Another parser that does not consume any input is the <code>check</code> parser that we
have mentioned earlier. It is actually a combinator since it takes another
parser as parameter. It checks that the given parser succeed but then return
the input stream unchanged (with a <code>unit</code> result). The only thing interesting
is that it explores forcing a success in case the check fails.</p></div>
<div class="listingblock">
<div class="title">Parser library: check</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> check <span style="color: #990000">?(</span>what<span style="color: #990000">=</span><span style="color: #FF0000">"check"</span><span style="color: #990000">)</span> p m e c s <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> what<span style="color: #990000">::</span>m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  ct_bind <span style="color: #990000">(</span>p m e c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> e'<span style="color: #990000">,</span> <span style="color: #990000">[]</span> <span style="color: #990000">-&gt;</span> fail_or_maybe_not <span style="color: #990000">()</span> m e' c s
    <span style="color: #990000">|</span> e'<span style="color: #990000">,</span> _ <span style="color: #990000">-&gt;</span> return <span style="color: #990000">()</span> m e' c s<span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> check <span style="color: #990000">:</span> <span style="color: #990000">?</span>what<span style="color: #990000">:</span><span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span> t</tt></pre></div></div>
<div class="paragraph"><p>Another parser that will prove useful (despite contributing no value to the
result) especially in coordination with <code>check</code> is the negation:</p></div>
<div class="listingblock">
<div class="title">Parser library: negation</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> nay p m e c s <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> <span style="color: #FF0000">"not"</span><span style="color: #990000">::</span>m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  ct_bind <span style="color: #990000">(</span>p m e c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> e'<span style="color: #990000">,</span> <span style="color: #990000">[]</span> <span style="color: #990000">-&gt;</span> return <span style="color: #990000">()</span> m e' c s
    <span style="color: #990000">|</span> e'<span style="color: #990000">,</span> _ <span style="color: #990000">-&gt;</span> fail_or_maybe_not <span style="color: #990000">()</span> m e' c s<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>So that we could write <code>check (nay p)</code>.</p></div>
<div class="paragraph"><p>Notice that when <code>nay</code> succeeds, ie when <code>p</code> fails, the stream of input
tokens <code>s</code> is <em>not</em> advanced. Indeed, we do not know of how many tokens
to advance it (since <code>p</code> could operate on several). (Note: is <code>check</code>
really useful then?)</p></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> nay <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span> t</tt></pre></div></div>
<div class="paragraph"><p>Notice that this <code>nay</code> parser do not consume any input.</p></div>
</div>
<div class="sect2">
<h3 id="_tests">4.2. Tests</h3>
<div class="paragraph"><p>It is important to have a test infrastructure in place before it&#8217;s needed.
Given literate programing allows us to mix code and tests at ease we do not
need to get this feature from such a tool as
<a href="https://github.com/vincent-hugot/iTeML">qtest</a> and will use
<a href="http://ounit.forge.ocamlcore.org/api-ounit/index.html">oUnit</a> directly.</p></div>
<div class="paragraph"><p>It would be convenient to have a function to convert a string into a <code>stream</code>,
and not only during tests but also for real use when all the input is available
at once.  Let&#8217;s thus add this into the <code>CONFIG</code> signature:</p></div>
<div class="listingblock">
<div class="title">Parser configuration: convert from string</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> stream_of_string <span style="color: #990000">:</span> <span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> stream</tt></pre></div></div>
<div class="listingblock">
<div class="title">other SimpleConfig definitions:</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream_of_string s <span style="color: #990000">=</span>
  <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>to_list s</tt></pre></div></div>
<div class="paragraph"><p>Supposing for now that we have also all the required printers we can set up a
satisfying environment for tests:</p></div>
<div class="listingblock">
<div class="title">test.ml: the stage.</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>
<span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">OUnit2</span>
<span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">ParsersMisc</span>
<span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">ParsersCorrections</span>

<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">P</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Parsers</span></span><span style="color: #990000">.</span><span style="color: #009900">Make</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Parsers</span></span><span style="color: #990000">.</span><span style="color: #009900">SimpleConfig</span> <span style="color: #990000">(</span><span style="color: #009900">Char</span><span style="color: #990000">))</span>
<span style="font-style: italic"><span style="color: #9A1900">(* ...other tested modules... *)</span></span>
<span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">P</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> max_changes <span style="color: #990000">=</span> <span style="color: #993399">3</span>
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> corr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>make max_changes
<span style="font-style: italic"><span style="color: #9A1900">(* TODO: two types of correction: replace and insert *)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> correction_at pos tok m <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> c <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>make max_changes <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  change_at c pos tok <span style="color: #990000">[</span> m <span style="color: #990000">]</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> no_corr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Parsers</span></span><span style="color: #990000">.</span>no_error_correction
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> rest <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"glop glop pas glop"</span>
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> no_input <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #990000">[]</span>
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> drop <span style="color: #990000">?(</span>sep_len<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">)</span> n <span style="color: #990000">(</span>o<span style="color: #990000">,</span> lst<span style="color: #990000">)</span> <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> n' <span style="color: #990000">=</span> <span style="color: #993399">1</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span>n<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)*(</span><span style="color: #993399">1</span><span style="color: #990000">+</span>sep_len<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  o <span style="color: #990000">+</span> n'<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>drop n' lst

<span style="font-style: italic"><span style="color: #9A1900">(* ...other global functions or types for testing... *)</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> uniq <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #990000">[</span>x<span style="color: #990000">,</span> _<span style="color: #990000">,</span> _<span style="color: #990000">]</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> x
  <span style="color: #990000">|</span> _ <span style="color: #990000">-&gt;</span> <span style="color: #009900">None</span>

<span style="font-style: italic"><span style="color: #9A1900">(* version of assert_equal specialized for parser results *)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> assert_same_results <span style="color: #990000">?</span>msg print_output exp got_ <span style="color: #990000">=</span>
  ct_bind got_ <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> got <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> printer <span style="color: #990000">=</span>
      <span style="font-weight: bold"><span style="color: #000080">IO</span></span><span style="color: #990000">.</span>to_string <span style="color: #990000">(</span>print_possible_results print_output<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> cmp <span style="color: #990000">(</span>exp_err<span style="color: #990000">,</span> exp<span style="color: #990000">)</span> <span style="color: #990000">(</span>act_err<span style="color: #990000">,</span> got<span style="color: #990000">)</span> <span style="color: #990000">=</span>
      <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> same_err <span style="color: #990000">=</span>
        <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> exp_err<span style="color: #990000">,</span> act_err <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
        <span style="color: #990000">|</span> <span style="color: #009900">None</span><span style="color: #990000">,</span> _ <span style="color: #990000">-&gt;</span>
          <span style="font-style: italic"><span style="color: #9A1900">(* Many times we do not want to guess the errors (for instance</span></span>
<span style="font-style: italic"><span style="color: #9A1900">             when the parser actually succeeds): *)</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
        <span style="color: #990000">|</span> <span style="color: #009900">Some</span> exp_err<span style="color: #990000">,</span> <span style="color: #009900">Some</span> act_err <span style="color: #990000">-&gt;</span>
          <span style="font-style: italic"><span style="color: #9A1900">(* Unless we give a deep exp_err we want to compare only the heads: *)</span></span>
          exp_err<span style="color: #990000">.</span>where <span style="color: #990000">=</span> act_err<span style="color: #990000">.</span>where <span style="color: #990000">&amp;&amp;</span>
          <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">match</span></span> exp_err<span style="color: #990000">.</span>what<span style="color: #990000">,</span> act_err<span style="color: #990000">.</span>what <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
          <span style="color: #990000">|</span> <span style="color: #990000">[</span>exp_head<span style="color: #990000">],</span> act_head<span style="color: #990000">::</span>_ <span style="color: #990000">-&gt;</span>
            <span style="color: #993399">0</span> <span style="color: #990000">=</span> compare exp_head act_head
          <span style="color: #990000">|</span> exp_what<span style="color: #990000">,</span> act_what <span style="color: #990000">-&gt;</span>
            <span style="color: #993399">0</span> <span style="color: #990000">=</span> compare exp_what act_what<span style="color: #990000">)</span>
        <span style="color: #990000">|</span> exp<span style="color: #990000">,</span> act <span style="color: #990000">-&gt;</span>
          <span style="color: #993399">0</span> <span style="color: #990000">=</span> compare exp act <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      same_err <span style="color: #990000">&amp;&amp;</span>
      <span style="color: #993399">0</span> <span style="color: #990000">=</span> compare <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>sort compare exp<span style="color: #990000">)</span>
                  <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>sort compare got<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    ct_return <span style="color: #990000">(</span>
      <span style="font-style: italic"><span style="color: #9A1900">(* OUnit really should have an assert_same_elements *)</span></span>
      assert_equal <span style="color: #990000">~</span>printer <span style="color: #990000">~</span>cmp <span style="color: #990000">?</span>msg exp got<span style="color: #990000">))</span> <span style="color: #990000">|&gt;</span>
  ignore

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">()</span> <span style="color: #990000">=</span>
  run_test_tt_main <span style="color: #990000">(</span>
    <span style="color: #FF0000">"test helpers"</span> <span style="color: #990000">&gt;:::</span>
      <span style="color: #990000">[</span> <span style="color: #FF0000">"stream_of_empty"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
          <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
            assert_equal <span style="color: #990000">~</span>printer<span style="color: #990000">:</span>string_of_int
              <span style="color: #993399">0</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>length <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">""</span> <span style="color: #990000">|&gt;</span> snd<span style="color: #990000">)))</span> <span style="color: #990000">;</span>
        <span style="color: #FF0000">"stream_of_string basic"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
          <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
            assert_equal <span style="color: #990000">~</span>printer<span style="color: #990000">:</span>string_of_int
              <span style="color: #993399">2</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>length <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">"ab"</span> <span style="color: #990000">|&gt;</span> snd<span style="color: #990000">)))</span> <span style="color: #990000">;</span>
        <span style="color: #FF0000">"(no) corrections allowed"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
          <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctl <span style="color: #990000">-&gt;</span>
            assert_bool <span style="color: #FF0000">"no_corr is full"</span>
              <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>is_full no_corr<span style="color: #990000">)</span> <span style="color: #990000">;</span>
            assert_bool <span style="color: #FF0000">"corr is not full"</span>
              <span style="color: #990000">(</span>not <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>is_full corr<span style="color: #990000">)))</span> <span style="color: #990000">;</span>
        <span style="color: #990000">])</span> <span style="color: #990000">;</span>
  run_test_tt_main <span style="color: #990000">(</span>
    <span style="color: #FF0000">"tests"</span> <span style="color: #990000">&gt;:::</span>
      <span style="color: #990000">[</span> <span style="font-style: italic"><span style="color: #9A1900">(* ...tests... *)</span></span> <span style="color: #990000">])</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that we have to force the type of <code>assert_same_results</code> to be <code>unit</code>
(with <code>ignore</code>) otherwise it would be <code>unit P.ct P.ct</code>, which should be
demonstrably equivalent to <code>unit</code> given <code>SimpleConfig</code> but still makes the
compiler to grumble.</p></div>
<div class="paragraph"><p>Let&#8217;s warm this up with simple tests for <code>return</code> and <code>fail</code> (which really does
not cause too much worries):</p></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"return succeed"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Int</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span><span style="color: #993399">42</span><span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> rest<span style="color: #990000">])</span>
      <span style="color: #990000">(</span>return <span style="color: #993399">42</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"return succeed even at EOF"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Int</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span><span style="color: #993399">42</span><span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">(</span>return <span style="color: #993399">42</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr no_input<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"fail fails"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Int</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>fail <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"fail fails even at EOF"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Int</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>fail <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr no_input<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_checking_for_end_of_stream">4.3. Checking for end of stream</h3>
<div class="paragraph"><p>Another very useful and basic parser is the one that succeeds on EOF and
fails everywhere else. It is useful to check that the input stream have been
consumed entirely by the preceding parsers.</p></div>
<div class="paragraph"><p>We do not engage in error detection in this parser: mimicking success implies
pretending the stream stops there, but most input streams could be trivially
declared valid if the stream is cut short (empty string is often valid for
instance). In case of spurious input tokens at the end shouldn&#8217;t the error
message be trivial enough already? Also, when error detection is allowed then
we (should) also try to skip tokens, which is enough to correct a few spurious
chars at the end.</p></div>
<div class="paragraph"><p>The real reason of course is none of the above. It is that forcing <code>eof</code> to
succeed would require an <em>empty_stream</em> from the configuration, which was
too inconvenient.</p></div>
<div class="listingblock">
<div class="title">Parser library: checking for EOF</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">ParsersMisc</span>
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> eof m e c s <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> <span style="color: #FF0000">"eof"</span><span style="color: #990000">::</span>m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> _<span style="color: #990000">,</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> s' <span style="color: #990000">-&gt;</span>
      return <span style="color: #990000">()</span> m e c s'
    <span style="color: #990000">|</span> pos<span style="color: #990000">,</span> _<span style="color: #990000">,</span> _ <span style="color: #990000">-&gt;</span>
      fail m <span style="color: #990000">(</span>new_error pos m e<span style="color: #990000">)</span> c s<span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> eof <span style="color: #990000">:</span> <span style="color: #009900">unit</span> t</tt></pre></div></div>
<div class="paragraph"><p>And the accompanying tests:</p></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"eof succeed"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Unit</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[(),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">(</span>eof <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr no_input<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"eof fails"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Unit</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> where <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #990000">;</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"eof"</span><span style="color: #990000">]</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>eof <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="font-style: italic"><span style="color: #9A1900">(*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">"eof suggests truncation" &gt;:: (</span></span>
<span style="font-style: italic"><span style="color: #9A1900">  fun _ctx -&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">    assert_same_results Unit.print</span></span>
<span style="font-style: italic"><span style="color: #9A1900">      (None, [(), correction_at 0 (Item 'g') "eof", (18,[]) ])</span></span>
<span style="font-style: italic"><span style="color: #9A1900">      (eof [] None corr rest)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">) ;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">*)</span></span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_first_non_trivial_parser">4.4. First non trivial parser</h3>
<div class="paragraph"><p>The more general of parsers that do consume some input is the <code>cond</code> parser,
which tries to recognize a condition on the next token (for instance that it
is equal to a given value). So <code>cond</code> is a function that takes a predicate on
token and returns a parser that, when given this token, returns it (and
consumes it), or otherwise fails (with a message describing what it was
looking for).</p></div>
<div class="paragraph"><p>Now that we know the type, writing the code is rather easy:</p></div>
<div class="listingblock">
<div class="title">A cond parser</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> cond expl f x m e c s <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> expl<span style="color: #990000">::</span>m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> _pos<span style="color: #990000">,</span> <span style="color: #009900">Item</span> tok<span style="color: #990000">,</span> s' <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> f tok <span style="color: #990000">-&gt;</span>
      return tok m e c s'
    <span style="color: #990000">|</span> _ <span style="color: #990000">-&gt;</span>
      fail_or_maybe_not x m e c s<span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> cond <span style="color: #990000">:</span> <span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>token <span style="color: #990000">-&gt;</span> <span style="color: #009900">bool</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> token <span style="color: #990000">-&gt;</span> token t</tt></pre></div></div>
<div class="paragraph"><p><code>cond_map</code> is a <code>cond</code> that returns an optional value instead of a mere
boolean:</p></div>
<div class="listingblock">
<div class="title">Parser library: cond_map</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> cond_map expl f x m e c s <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> expl<span style="color: #990000">::</span>m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> _pos<span style="color: #990000">,</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> _ <span style="color: #990000">-&gt;</span>
      fail_or_maybe_not x m e c s
    <span style="color: #990000">|</span> _pos<span style="color: #990000">,</span> <span style="color: #009900">Item</span> tok<span style="color: #990000">,</span> s' <span style="color: #990000">-&gt;</span>
      <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">match</span></span> f tok <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
       <span style="color: #990000">|</span> <span style="color: #009900">Some</span> v <span style="color: #990000">-&gt;</span> return v m e c s'
       <span style="color: #990000">|</span> <span style="color: #009900">None</span>   <span style="color: #990000">-&gt;</span> fail_or_maybe_not x m e c s<span style="color: #990000">))</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> cond_map <span style="color: #990000">:</span> <span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>token <span style="color: #990000">-&gt;</span> 'b <span style="color: #009900">option</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> 'b <span style="color: #990000">-&gt;</span> 'b t</tt></pre></div></div>
<div class="paragraph"><p>from which a simpler <code>cond</code> parser can be written:</p></div>
<div class="listingblock">
<div class="title">Parser library: the cond parser, revisited</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> cond expl f <span style="color: #990000">=</span>
  cond_map expl <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> f c <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="color: #009900">Some</span> c <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #009900">None</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>It is possible to build many simpler and more convenient parsers on top of
<code>cond</code>, such as <code>item</code> which expects a specific token in the input, and
<code>range</code> which expect anything in the given token range (assuming token
behavior in face of an inequality operator makes sense) :</p></div>
<div class="listingblock">
<div class="title">Parser library: the item parser</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> item <span style="color: #990000">?</span>what x <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> expl <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">Option</span></span><span style="color: #990000">.</span>default_delayed <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span>
      <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>sprintf2 <span style="color: #FF0000">"%a"</span> print_token x<span style="color: #990000">)</span> what <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  cond expl <span style="color: #990000">((=)</span> x<span style="color: #990000">)</span> x

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> range a b expl <span style="color: #990000">=</span>
  cond expl <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span> c <span style="color: #990000">&gt;=</span> a <span style="color: #990000">&amp;&amp;</span> c <span style="color: #990000">&lt;=</span> b<span style="color: #990000">)</span> a</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> item <span style="color: #990000">:</span> <span style="color: #990000">?</span>what<span style="color: #990000">:</span><span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> token <span style="color: #990000">-&gt;</span> token t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> range <span style="color: #990000">:</span> token <span style="color: #990000">-&gt;</span> token <span style="color: #990000">-&gt;</span> <span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> token t</tt></pre></div></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"item canonical success"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>'g'<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>tl <span style="color: #990000">(</span>snd rest<span style="color: #990000">))])</span>
      <span style="color: #990000">(</span>item 'g' <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"item canonical failure"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"X"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>item '<span style="color: #009900">X</span>' <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"item fails at EOF"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"g"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>item 'g' <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr no_input<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"item error exploration"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="font-style: italic"><span style="color: #9A1900">(* Here we 'find' the item X just because we add it. *)</span></span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"X"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
       <span style="color: #990000">[</span> '<span style="color: #009900">X</span>'<span style="color: #990000">,</span> correction_at <span style="color: #993399">0</span> <span style="color: #990000">(</span><span style="color: #009900">Item</span> 'g'<span style="color: #990000">)</span> <span style="color: #FF0000">"X"</span><span style="color: #990000">,</span>
         rest <span style="font-style: italic"><span style="color: #9A1900">(* since we add X in front of rest *)</span></span> <span style="color: #990000">])</span>
      <span style="color: #990000">(</span>item '<span style="color: #009900">X</span>' <span style="color: #990000">[]</span> <span style="color: #009900">None</span> corr rest<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modifying_parsers_result">5. Modifying parsers result</h2>
<div class="sectionbody">
<div class="paragraph"><p>Before going too far we need to introduce functions that alter a parser result
(equivalent of map, fold, filter&#8230;) and come up with a convenient syntax for
those since they are going to be used prevalently.</p></div>
<div class="listingblock">
<div class="title">Applying a function to all results of a parser, take 1</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> map p f m e c s <span style="color: #990000">=</span>
  ct_bind <span style="color: #990000">(</span>p m e c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> results<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> results' <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>map <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>x<span style="color: #990000">,</span> corr<span style="color: #990000">,</span> rest<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      f x<span style="color: #990000">,</span> corr<span style="color: #990000">,</span> rest<span style="color: #990000">)</span> results <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    ct_return <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> results'<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The order of parameters is important so that <code>map p f</code> is itself a parser.  In
practice though, we often want to filter the results in addition to mapping
them.  For instance, <code>p</code> should be a parser for numbers and we want to convert
the sequence of character it outputs into a number, but want to accept only
numbers below some limit. We will therefore allow f to throw a special
exception to reject a solution:</p></div>
<div class="listingblock">
<div class="title">Parser library: applying a function to all results of a parser, take 2</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">exception</span></span> <span style="color: #009900">Reject</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #009900">string</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> map p f m e c s <span style="color: #990000">=</span>
  ct_bind <span style="color: #990000">(</span>p m e c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> results<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> rejection <span style="color: #990000">=</span> <span style="color: #009900">ref</span> <span style="color: #009900">None</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> results' <span style="color: #990000">=</span>
      <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>filter_map <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>x<span style="color: #990000">,</span> corr<span style="color: #990000">,</span> rest<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #009900">Some</span> <span style="color: #990000">(</span>f x<span style="color: #990000">,</span> corr<span style="color: #990000">,</span> rest<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="color: #009900">Reject</span> msg <span style="color: #990000">-&gt;</span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">!</span>rejection <span style="color: #990000">=</span> <span style="color: #009900">None</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
            rejection <span style="color: #990000">:=</span> <span style="color: #009900">Some</span> msg <span style="color: #990000">;</span>
          <span style="color: #009900">None</span><span style="color: #990000">)</span> results <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> <span style="color: #990000">!</span>rejection <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
    <span style="color: #990000">|</span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span> ct_return <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> results'<span style="color: #990000">)</span>
    <span style="color: #990000">|</span> <span style="color: #009900">Some</span> msg <span style="color: #990000">-&gt;</span>
      ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> _<span style="color: #990000">,</span> _<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
        ct_return <span style="color: #990000">(</span>new_error pos <span style="color: #990000">(</span>msg<span style="color: #990000">::</span>m<span style="color: #990000">)</span> e'<span style="color: #990000">,</span> results'<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>An infix operator makes it even more convenient:</p></div>
<div class="listingblock">
<div class="title">Parser library: infix operator for map</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">(&gt;&gt;:)</span> <span style="color: #990000">=</span> map</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">exception</span></span> <span style="color: #009900">Reject</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #009900">string</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> map   <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #990000">-&gt;</span> 'd<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> 'd t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> <span style="color: #990000">(&gt;&gt;:)</span> <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #990000">-&gt;</span> 'd<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> 'd t</tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_combinators">6. Combinators</h2>
<div class="sectionbody">
<div class="paragraph"><p>The first combinators to consider are the succession of two given parsers and
the alternative of two parsers.</p></div>
<div class="paragraph"><p>Notice that since we are now merely combining parsers we do not have to care
about error correction any more: only the base parsers need to pretend
succeeding when they fail.</p></div>
<div class="paragraph"><p>The more general way to build a combinator for the succession of two parsers is
to take the first parser <code>p1</code> and a function <code>f</code> which, given the output of
<code>p1</code>, will return a parser <code>p2</code> to apply to the remaining of the input stream.
Let&#8217;s call this combinator <code>bind</code> (by analogy with the type of the <code>bind</code>
operation in the monad &#8220;design pattern&#8221;). The values of <code>bind p1 f</code> are the
values of <code>p2</code>, <code>p1</code> intermediary values being only meaningful to build <code>p2</code>.</p></div>
<div class="listingblock">
<div class="title">Parser library: bind</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> bind p1 f m e c s <span style="color: #990000">=</span>
  ct_bind <span style="color: #990000">(</span>p1 m e c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> r<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
    <span style="font-style: italic"><span style="color: #9A1900">(* For each possible result of p1, try to continue parsing with p2.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       Aggregate all encountered errors. *)</span></span>
    <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>fold_left <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> prev <span style="color: #990000">(</span>x1<span style="color: #990000">,</span> c'<span style="color: #990000">,</span> s'<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
        ct_bind prev <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e''<span style="color: #990000">,</span> r'<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
          <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> p2 <span style="color: #990000">=</span> f x1 <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
          ct_bind <span style="color: #990000">(</span>p2 m e'' c' s'<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e'''<span style="color: #990000">,</span> r''<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
            ct_return <span style="color: #990000">(</span>e'''<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>rev_append r'' r'<span style="color: #990000">)))</span>
      <span style="color: #990000">)</span> <span style="color: #990000">(</span>ct_return <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> <span style="color: #990000">[]))</span> r<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>With the conventional infix operator:</p></div>
<div class="listingblock">
<div class="title">Parser library: infix operator for bind</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">(&gt;&gt;=)</span> <span style="color: #990000">=</span> bind</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> bind  <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #990000">-&gt;</span> 'd t<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> 'd t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> <span style="color: #990000">(&gt;&gt;=)</span> <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #990000">-&gt;</span> 'd t<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> 'd t</tt></pre></div></div>
<div class="paragraph"><p>Given this <code>bind</code> combinator, the concatenation of two given parsers <code>p1</code> and
<code>p2</code> can be easily written as:</p></div>
<div class="listingblock">
<div class="title">Parser library: succession of two parsers</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> cons p1 p2 <span style="color: #990000">=</span>
  p1 <span style="color: #990000">&gt;&gt;=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> x1 <span style="color: #990000">-&gt;</span> p2 <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> x2 <span style="color: #990000">-&gt;</span> x1<span style="color: #990000">,</span>x2<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Here, we want the final result set to be the product of each result of <code>p1</code>
with all following results of <code>p2</code>.</p></div>
<div class="paragraph"><p>We&#8217;d better have a shorter infix alternative for <code>cons</code> which is used very
often:</p></div>
<div class="listingblock">
<div class="title">Parser library: infix operator for cons</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">(++)</span> p1 p2 <span style="color: #990000">=</span> cons p1 p2</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> cons <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> 'd t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #990000">*</span> 'd<span style="color: #990000">)</span> t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> <span style="color: #990000">(++)</span> <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> 'd t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #990000">*</span> 'd<span style="color: #990000">)</span> t</tt></pre></div></div>
<div class="paragraph"><p>Also, we will often discard the result of one parser. For instance when
parsing delimiters the only information is that the parser succeeds (there is
a delimiter) but there is no value to attach to that success. Also when using
the <code>check</code> parser, which purpose is really not its return value. So here are
three variants of <code>cons</code>: one that ignores the result of <code>p1</code>, one that
ignores the result of <code>p2</code> and one that ignore both (returning <code>()</code>):</p></div>
<div class="listingblock">
<div class="title">Parser library: other convenient infix operators</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">(+-)</span> p1 p2 <span style="color: #990000">=</span> p1 <span style="color: #990000">++</span> p2 <span style="color: #990000">&gt;&gt;:</span> fst
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">(-+)</span> p1 p2 <span style="color: #990000">=</span> p1 <span style="color: #990000">++</span> p2 <span style="color: #990000">&gt;&gt;:</span> snd
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">(--)</span> p1 p2 <span style="color: #990000">=</span> p1 <span style="color: #990000">++</span> p2 <span style="color: #990000">&gt;&gt;:</span> ignore</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> <span style="color: #990000">(+-)</span> <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> 'd t <span style="color: #990000">-&gt;</span> 'b t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> <span style="color: #990000">(-+)</span> <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> 'd t <span style="color: #990000">-&gt;</span> 'd t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> <span style="color: #990000">(--)</span> <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> 'd t <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span> t</tt></pre></div></div>
<div class="paragraph"><p>Conveniently all those are left associative.</p></div>
<div class="paragraph"><p>Now let&#8217;s test that we can indeed sequence parsers:</p></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"Can parse a sequence"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ab <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"ab"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Tuple2</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[(</span>'a'<span style="color: #990000">,</span> 'b'<span style="color: #990000">),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">((</span>item 'a' <span style="color: #990000">++</span> item 'b'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr ab<span style="color: #990000">)</span> <span style="color: #990000">;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>'a'<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">((</span>item 'a' <span style="color: #990000">+-</span> item 'b'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr ab<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>The next most useful combinator is the alternative:</p></div>
<div class="listingblock">
<div class="title">The alternative, take 1</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> oneof p1 p2 m e c s <span style="color: #990000">=</span>
  ct_bind <span style="color: #990000">(</span>p1 m e c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> r<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
    ct_bind <span style="color: #990000">(</span>p2 m e' c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e''<span style="color: #990000">,</span> r'<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      ct_return <span style="color: #990000">(</span>e''<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>rev_append r r'<span style="color: #990000">)))</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;which simply try each parser in turn, accumulate the best error and combine
the possible results.</p></div>
<div class="paragraph"><p>There is a small inconvenience here: if both terms of the alternative <code>p1</code> and
<code>p2</code> failed right from the start, then the resulting error will be about <code>p2</code>.
It is probably more insightful in this case to report that the <code>oneof</code> itself
failed.</p></div>
<div class="paragraph"><p>To obtain this behavior an additional error for the alternative itself can be
registered for the starting position and it will overwrite the best error <code>e''</code>
if it&#8217;s also located there.</p></div>
<div class="paragraph"><p>If either <code>p1</code> or <code>p2</code> managed to parse even a tiny bit of <code>s</code> then it will
still be favored in the error report, which might or not be good depending on
how <em>likely</em> this parser fails late on random data.</p></div>
<div class="listingblock">
<div class="title">Parser library: alternative</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> oneof p1 p2 m e c s <span style="color: #990000">=</span>
  ct_bind <span style="color: #990000">(</span>p1 m e c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> r<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
    ct_bind <span style="color: #990000">(</span>p2 m e' c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e''<span style="color: #990000">,</span> r'<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> _<span style="color: #990000">,</span> _<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> r'' <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>rev_append r r' <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> e''' <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> r'' <span style="color: #990000">=</span> <span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> new_error pos m e''
                               <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> e'' <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        ct_return <span style="color: #990000">(</span>e'''<span style="color: #990000">,</span> r''<span style="color: #990000">))))</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">(|||)</span> <span style="color: #990000">=</span> oneof</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> oneof <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> 'b t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> <span style="color: #990000">(|||)</span> <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> 'b t</tt></pre></div></div>
<div class="paragraph"><p>Notice that results are really sets not list, so the order in which the
alternatives are listed does not matter.  Notice also that this is not an
exclusive alternative: if both <code>p1</code> and <code>p2</code> can parse then both will
contribute a result to the result set. As discussed in the beginning we do
not enforce that if <code>p1</code> succeeds then <code>p2</code> must fail nor the other way
around. If this is wanted though then it is easy enough to write:</p></div>
<div class="listingblock">
<div class="title">Parser library: exclusive alternative</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> either p1 p2 <span style="color: #990000">=</span>
  <span style="color: #990000">(</span>nay p2 <span style="color: #990000">-+</span> p1<span style="color: #990000">)</span> <span style="color: #990000">|||</span> <span style="color: #990000">(</span>nay p1 <span style="color: #990000">-+</span> p2<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #990000">(|/|)</span> <span style="color: #990000">=</span> either</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> either <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> 'b t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> <span style="color: #990000">(|/|)</span>  <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> 'b t</tt></pre></div></div>
<div class="paragraph"><p>With sequences and alternatives we can start writing some interesting tests:</p></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"any: 'a' or 'b' but not 'z'"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> a_or_b m <span style="color: #990000">=</span>
      <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> <span style="color: #FF0000">"a or b"</span> <span style="color: #990000">::</span> m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      <span style="color: #990000">(</span>item 'a' <span style="color: #990000">|||</span> item 'b'<span style="color: #990000">)</span> m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> z <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"z"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>'a'<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">(</span>a_or_b <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">"a"</span><span style="color: #990000">))</span> <span style="color: #990000">;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>'b'<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">(</span>a_or_b <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">"b"</span><span style="color: #990000">))</span> <span style="color: #990000">;</span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"a or b"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>a_or_b <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr z<span style="color: #990000">)</span> <span style="color: #990000">;</span>
    <span style="font-style: italic"><span style="color: #9A1900">(* Here we try with corrections: we make up the requested item</span></span>
<span style="font-style: italic"><span style="color: #9A1900">       in front of the actual one (check the 2 possibilities): *)</span></span>
    assert_same_results <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"b"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
       <span style="color: #990000">[</span>'a'<span style="color: #990000">,</span> correction_at <span style="color: #993399">0</span> <span style="color: #990000">(</span><span style="color: #009900">Item</span> 'z'<span style="color: #990000">)</span> <span style="color: #FF0000">"a"</span><span style="color: #990000">,</span> z <span style="color: #990000">;</span>
        'b'<span style="color: #990000">,</span> correction_at <span style="color: #993399">0</span> <span style="color: #990000">(</span><span style="color: #009900">Item</span> 'z'<span style="color: #990000">)</span> <span style="color: #FF0000">"b"</span><span style="color: #990000">,</span> z<span style="color: #990000">])</span>
      <span style="color: #990000">(</span>a_or_b <span style="color: #990000">[]</span> <span style="color: #009900">None</span> corr z<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_repeating_parsers">7. Repeating parsers</h2>
<div class="sectionbody">
<div class="paragraph"><p>Binding several parsers already gives us a way to harvest several values from
the input stream but many times what is needed is to repeat the same parser an
unspecified number of times.</p></div>
<div class="paragraph"><p>Before that, a special case of repetition will prove very useful: having zero
or one occurrence of <code>p</code>:</p></div>
<div class="listingblock">
<div class="title">Parser library: zero or one</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> optional <span style="color: #990000">~</span>def p <span style="color: #990000">=</span> p <span style="color: #990000">|||</span> return def
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> optional_greedy <span style="color: #990000">~</span>def p m e c s <span style="color: #990000">=</span>
  ct_bind <span style="color: #990000">(</span>p m e c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> e'<span style="color: #990000">,</span> <span style="color: #990000">[]</span> <span style="color: #990000">-&gt;</span> ct_return <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> <span style="color: #990000">[</span>def<span style="color: #990000">,</span> c<span style="color: #990000">,</span> s<span style="color: #990000">])</span>
    <span style="color: #990000">|</span> x <span style="color: #990000">-&gt;</span> ct_return x<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The <code>optional_greedy</code> above is to avoid considering not consuming a matching
token as a possible solution.</p></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> optional <span style="color: #990000">:</span> def<span style="color: #990000">:</span>'b <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> 'b t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> optional_greedy <span style="color: #990000">:</span> def<span style="color: #990000">:</span>'b <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> 'b t</tt></pre></div></div>
<div class="paragraph"><p>Which behavior we&#8217;d better test:</p></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"optional behavior"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> opt_char c <span style="color: #990000">=</span> optional <span style="color: #990000">~</span>def<span style="color: #990000">:</span>'x' <span style="color: #990000">(</span>item c<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ab <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"ab"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Tuple2</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[(</span>'a'<span style="color: #990000">,</span> 'b'<span style="color: #990000">),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">((</span>opt_char 'a' <span style="color: #990000">++</span> item 'b'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr ab<span style="color: #990000">)</span> <span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> b <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"b"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Tuple2</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[(</span>'x'<span style="color: #990000">,</span> 'b'<span style="color: #990000">),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">((</span>opt_char 'a' <span style="color: #990000">++</span> item 'b'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr b<span style="color: #990000">)</span> <span style="color: #990000">;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Tuple2</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[(</span>'x'<span style="color: #990000">,</span> 'b'<span style="color: #990000">),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,[])</span> <span style="color: #990000">;</span>
              <span style="color: #990000">(</span>'b'<span style="color: #990000">,</span> 'x'<span style="color: #990000">),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,[])</span> <span style="color: #990000">;</span>
              <span style="color: #990000">(</span>'x'<span style="color: #990000">,</span> 'x'<span style="color: #990000">),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,[</span>'b'<span style="color: #990000">])])</span>
      <span style="color: #990000">((</span>opt_char 'b' <span style="color: #990000">++</span> opt_char 'b'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr b<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"optional_greedy really is"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> opt_char c <span style="color: #990000">=</span> optional_greedy <span style="color: #990000">~</span>def<span style="color: #990000">:</span>'x' <span style="color: #990000">(</span>item c<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ab <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"ab"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Tuple2</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[(</span>'a'<span style="color: #990000">,</span> 'b'<span style="color: #990000">),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">((</span>opt_char 'a' <span style="color: #990000">++</span> item 'b'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr ab<span style="color: #990000">)</span> <span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> b <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"b"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Tuple2</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[(</span>'x'<span style="color: #990000">,</span> 'b'<span style="color: #990000">),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">((</span>opt_char 'a' <span style="color: #990000">++</span> item 'b'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr b<span style="color: #990000">)</span> <span style="color: #990000">;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Tuple2</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[(</span>'b'<span style="color: #990000">,</span> 'x'<span style="color: #990000">),</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">,[])])</span>
      <span style="color: #990000">((</span>opt_char 'b' <span style="color: #990000">++</span> opt_char 'b'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr b<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Sometime it&#8217;s more convenient that the optional parser return an optional value
instead of a default one. Then one can use <code>None</code> as the default and combine
the parser with this <code>some</code> parser, to make <code>optional</code> returns an option type:</p></div>
<div class="listingblock">
<div class="title">Parser library: some</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> some p <span style="color: #990000">=</span> p <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> x <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> x</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> some <span style="color: #990000">:</span> 'a t <span style="color: #990000">-&gt;</span> 'a <span style="color: #009900">option</span> t</tt></pre></div></div>
<div class="paragraph"><p>The <code>repeat</code> combinator is a swiss-army knife for all variants of
repetitions, requiring a parser <code>p</code> to succeed from <code>min</code> to <code>max</code> times
consecutively, with an optional additional parser <code>sep</code> for a separator in
between <code>p</code> occurrences.  It returns a list of all values returned by the
successive <code>p</code>.</p></div>
<div class="paragraph"><p>By allowing <code>min</code> to be <code>0</code> (and making it the default value) we expect to
cut down on the many <code>optional (repeat p)</code> that we would have otherwise.</p></div>
<div class="listingblock">
<div class="title">Parser library: repetition of a parser</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> repeat <span style="color: #990000">~</span>sep <span style="color: #990000">?(</span>min<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #990000">?</span>max <span style="color: #990000">?</span>what p m <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> what <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span> m <span style="color: #990000">|</span> <span style="color: #009900">Some</span> w <span style="color: #990000">-&gt;</span> w<span style="color: #990000">::</span>m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> loop <span style="color: #990000">~</span>min <span style="color: #990000">?</span>max m e c s <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> max <span style="color: #990000">=</span> <span style="color: #009900">Some</span> <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="color: #990000">(</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> min <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> return <span style="color: #990000">[]</span> m e c s
      <span style="font-style: italic"><span style="color: #9A1900">(* note: if fail was taking this token itself then we could</span></span>
<span style="font-style: italic"><span style="color: #9A1900">         get away with repeating the full m e c s parameters everywhere *)</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
        ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> _<span style="color: #990000">,</span> _<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
          fail m <span style="color: #990000">(</span>new_error pos m e<span style="color: #990000">)</span> c s<span style="color: #990000">)</span>
    <span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #990000">(</span>
      <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> pred_ma <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> max <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">None</span>
                                 <span style="color: #990000">|</span> <span style="color: #009900">Some</span> m <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> <span style="color: #990000">(</span>m<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> min <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
      <span style="color: #990000">|</span> <span style="color: #993399">0</span> <span style="color: #990000">-&gt;</span>
        <span style="font-style: italic"><span style="color: #9A1900">(* we may stop here or continue *)</span></span>
        <span style="color: #990000">(</span>optional <span style="color: #990000">~</span>def<span style="color: #990000">:[]</span> <span style="color: #990000">(</span>loop <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span> <span style="color: #990000">?</span>max<span style="color: #990000">))</span> m e c s
      <span style="color: #990000">|</span> <span style="color: #993399">1</span> <span style="color: #990000">-&gt;</span>
        <span style="font-style: italic"><span style="color: #9A1900">(* If max is greater or unset, we want at least one more and</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           keep trying. But if max is also 1 then we just want one more</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           and there is no point looking further; which may avoid to block</span></span>
<span style="font-style: italic"><span style="color: #9A1900">           to another block in some settings: *)</span></span>
        <span style="color: #990000">(</span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> pred_ma <span style="color: #990000">=</span> <span style="color: #009900">Some</span> <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> p <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> x <span style="color: #990000">-&gt;</span> <span style="color: #990000">[</span>x<span style="color: #990000">]</span>
          <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #990000">(</span>p <span style="color: #990000">++</span> optional <span style="color: #990000">~</span>def<span style="color: #990000">:[]</span>
                       <span style="color: #990000">(</span>sep <span style="color: #990000">-+</span> <span style="color: #990000">(</span>loop <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span> <span style="color: #990000">?</span>max<span style="color: #990000">:</span>pred_ma<span style="color: #990000">)))</span> <span style="color: #990000">&gt;&gt;:</span>
                <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>x<span style="color: #990000">,</span> xs<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> x<span style="color: #990000">::</span>xs
        <span style="color: #990000">)</span> m e c s
      <span style="color: #990000">|</span> _ <span style="color: #990000">-&gt;</span>
        <span style="font-style: italic"><span style="color: #9A1900">(* above that, repetition is mandatory *)</span></span>
        <span style="color: #990000">((</span>p <span style="color: #990000">+-</span> sep <span style="color: #990000">++</span> loop <span style="color: #990000">~</span>min<span style="color: #990000">:(</span>min<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">?</span>max<span style="color: #990000">:</span>pred_ma<span style="color: #990000">)</span> <span style="color: #990000">&gt;&gt;:</span>
          <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>x<span style="color: #990000">,</span> xs<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> x<span style="color: #990000">::</span>xs<span style="color: #990000">)</span> m e c s
    <span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  loop <span style="color: #990000">~</span>min <span style="color: #990000">?</span>max m</tt></pre></div></div>
<div class="paragraph"><p>Notice there are two conditions that terminate the recursion: <code>max</code> reaching
<code>0</code> (no more occurrences permitted) or, when <code>min &gt; 0</code>, a failure of <code>p</code>.</p></div>
<div class="paragraph"><p>Notice also that repeat builds a whole list before sending it to the next
stage.  We&#8217;d like to get away with this list which most often than not will be
mapped into something else. A variant of lazy list would likely be preferable
here (as in other places).</p></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> repeat <span style="color: #990000">:</span>
  sep<span style="color: #990000">:</span>'d t <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>min<span style="color: #990000">:</span><span style="color: #009900">int</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>max<span style="color: #990000">:</span><span style="color: #009900">int</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>what<span style="color: #990000">:</span><span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #009900">list</span><span style="color: #990000">)</span> t</tt></pre></div></div>
<div class="paragraph"><p>We&#8217;d like to get away with the mandatory <code>sep</code> parameter using a default value
of <code>return ()</code> but that would prevent OCaml compiler to infer that since <code>sep</code>
result is consistently discarded any result type would be as good.  Simpler
example of this using the <em>REPL</em>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># let f ?sep x = x ;;
val f : ?sep:'a -&gt; 'b -&gt; 'b = &lt;fun&gt;
# let f ?(sep=42) x = x;;
val f : ?sep:int -&gt; 'a -&gt; 'a = &lt;fun&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Therefore we merely provide this short do-nothing constant parser to be used
when there is no separator:</p></div>
<div class="listingblock">
<div class="title">Parser library: none</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> none m <span style="color: #990000">=</span> return <span style="color: #990000">()</span> m</tt></pre></div></div>
<div class="paragraph"><p>You may be surprised by this notation, either because you were expecting <code>let
none corr rest = return () corr rest</code> or the shorter <code>let none = return ()</code>.
Refer to the <a href="#type-generalization">section about type generalization</a> if that
is the case.</p></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> none <span style="color: #990000">:</span> <span style="color: #009900">unit</span> t</tt></pre></div></div>
<div class="paragraph"><p>We can easily define the greedy version of <code>repeat</code> (that is, a version that
swallows as many <code>p</code> occurrences as present in the input stream) using check:</p></div>
<div class="listingblock">
<div class="title">(erroneous) greedy repetition</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> repeat_greedy <span style="color: #990000">~</span>sep <span style="color: #990000">?</span>min <span style="color: #990000">?</span>max <span style="color: #990000">?</span>what p <span style="color: #990000">=</span>
  repeat <span style="color: #990000">~</span>sep <span style="color: #990000">?</span>min <span style="color: #990000">?</span>max <span style="color: #990000">?</span>what p <span style="color: #990000">+-</span> nay <span style="color: #990000">(</span>sep <span style="color: #990000">-+</span> p<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;which unfortunately fails for <code>min=0</code> because of the separator.  We have to
be more cautious not to allow an input stream starting with <code>p</code> before
returning <code>[]</code>:</p></div>
<div class="listingblock">
<div class="title">Parser library: greedy repetition</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> repeat_greedy <span style="color: #990000">~</span>sep <span style="color: #990000">?</span>min <span style="color: #990000">?</span>max <span style="color: #990000">?</span>what p <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> min <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
  <span style="color: #990000">|</span> <span style="color: #009900">None</span> <span style="color: #990000">|</span> <span style="color: #009900">Some</span> <span style="color: #993399">0</span> <span style="color: #990000">-&gt;</span>
    repeat_greedy <span style="color: #990000">~</span>sep <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span> <span style="color: #990000">?</span>max <span style="color: #990000">?</span>what p <span style="color: #990000">|||</span>
    <span style="color: #990000">(</span>nay p <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">[])</span>
  <span style="color: #990000">|</span> min <span style="color: #990000">-&gt;</span>
    repeat <span style="color: #990000">~</span>sep <span style="color: #990000">?</span>min <span style="color: #990000">?</span>max <span style="color: #990000">?</span>what p <span style="color: #990000">+-</span>
    <span style="color: #990000">(</span>nay <span style="color: #990000">(</span>sep <span style="color: #990000">--</span> p<span style="color: #990000">)</span> <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">[])</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> repeat_greedy <span style="color: #990000">:</span>
  sep<span style="color: #990000">:</span>'d t <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>min<span style="color: #990000">:</span><span style="color: #009900">int</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>max<span style="color: #990000">:</span><span style="color: #009900">int</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>what<span style="color: #990000">:</span><span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #009900">list</span><span style="color: #990000">)</span> t</tt></pre></div></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"repetition: canonical successes"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> assert_ok <span style="color: #990000">?(</span>greedy<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">)</span> <span style="color: #990000">~</span>sep <span style="color: #990000">?</span>min <span style="color: #990000">?</span>max rest exp <span style="color: #990000">=</span>
      assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span> exp
        <span style="color: #990000">((</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> greedy <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> repeat_greedy <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> repeat<span style="color: #990000">)</span>
           <span style="color: #990000">~</span>sep <span style="color: #990000">?</span>min <span style="color: #990000">?</span>max <span style="color: #990000">(</span>item 'a'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> test_with_sep sep sep_len rest <span style="color: #990000">=</span>
      assert_ok <span style="color: #990000">~</span>sep rest
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span>
         <span style="color: #990000">[[</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">],</span> no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">3</span> rest <span style="color: #990000">;</span>
          <span style="color: #990000">[</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">],</span>     no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">2</span> rest <span style="color: #990000">;</span>
          <span style="color: #990000">[</span>'a'<span style="color: #990000">],</span>         no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">1</span> rest <span style="color: #990000">;</span>
          <span style="color: #990000">[],</span>            no_corr<span style="color: #990000">,</span> rest<span style="color: #990000">])</span> <span style="color: #990000">;</span>
      <span style="font-style: italic"><span style="color: #9A1900">(* Same with min=2 *)</span></span>
      assert_ok <span style="color: #990000">~</span>sep <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">2</span> rest
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span>
         <span style="color: #990000">[[</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">],</span> no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">3</span> rest <span style="color: #990000">;</span>
          <span style="color: #990000">[</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">],</span>     no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">2</span> rest<span style="color: #990000">])</span> <span style="color: #990000">;</span>
      <span style="font-style: italic"><span style="color: #9A1900">(* Testing max=2 *)</span></span>
      assert_ok <span style="color: #990000">~</span>sep <span style="color: #990000">~</span>max<span style="color: #990000">:</span><span style="color: #993399">2</span> rest
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span>
         <span style="color: #990000">[[</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">],</span>     no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">2</span> rest<span style="color: #990000">;</span>
          <span style="color: #990000">[</span>'a'<span style="color: #990000">],</span>         no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">1</span> rest<span style="color: #990000">;</span>
          <span style="color: #990000">[],</span>            no_corr<span style="color: #990000">,</span> rest<span style="color: #990000">])</span> <span style="color: #990000">;</span>
      <span style="font-style: italic"><span style="color: #9A1900">(* Now with min and max *)</span></span>
      assert_ok <span style="color: #990000">~</span>sep <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span> <span style="color: #990000">~</span>max<span style="color: #990000">:</span><span style="color: #993399">2</span> rest
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span>
         <span style="color: #990000">[[</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">],</span>     no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">2</span> rest <span style="color: #990000">;</span>
          <span style="color: #990000">[</span>'a'<span style="color: #990000">],</span>         no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">1</span> rest<span style="color: #990000">])</span> <span style="color: #990000">;</span>
      <span style="font-style: italic"><span style="color: #9A1900">(* min = max *)</span></span>
      assert_ok <span style="color: #990000">~</span>sep <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">2</span> <span style="color: #990000">~</span>max<span style="color: #990000">:</span><span style="color: #993399">2</span> rest
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[[</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">],</span>     no_corr<span style="color: #990000">,</span> drop <span style="color: #990000">~</span>sep_len <span style="color: #993399">2</span> rest<span style="color: #990000">])</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> aaab <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"aaab"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> a_a_a_b <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"a_a_a_b"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> _a_a_a_b <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"_a_a_a_b"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    test_with_sep none       <span style="color: #993399">0</span> aaab <span style="color: #990000">;</span>
    test_with_sep underscore <span style="color: #993399">1</span> a_a_a_b <span style="color: #990000">;</span>
    assert_ok <span style="color: #990000">~</span>greedy<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none aaab
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span>
       <span style="color: #990000">[[</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">],</span> no_corr<span style="color: #990000">,</span> drop <span style="color: #993399">3</span> aaab<span style="color: #990000">])</span> <span style="color: #990000">;</span>
    assert_ok <span style="color: #990000">~</span>greedy<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>underscore a_a_a_b
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span>
       <span style="color: #990000">[[</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">;</span>'a'<span style="color: #990000">],</span> no_corr<span style="color: #990000">,</span> drop <span style="color: #993399">5</span> a_a_a_b<span style="color: #990000">])</span> <span style="color: #990000">;</span>
    <span style="font-style: italic"><span style="color: #9A1900">(* Do not allow a separator at start *)</span></span>
    assert_ok <span style="color: #990000">~</span>greedy<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>underscore _a_a_a_b
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[[],</span> no_corr<span style="color: #990000">,</span> _a_a_a_b<span style="color: #990000">])</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"repetition: simplest failure"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"a"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>repeat <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span> <span style="color: #990000">(</span>item 'a'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">"zaab"</span><span style="color: #990000">))</span> <span style="color: #990000">;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"a"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>repeat_greedy <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span> <span style="color: #990000">(</span>item 'a'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">"zaab"</span><span style="color: #990000">))</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"repetition: missing separator"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"-"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>repeat <span style="color: #990000">~</span>sep<span style="color: #990000">:(</span>item '<span style="color: #990000">-</span>'<span style="color: #990000">)</span> <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">3</span> <span style="color: #990000">(</span>item 'a'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">"a-aab"</span><span style="color: #990000">))</span> <span style="color: #990000">;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"-"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>repeat_greedy <span style="color: #990000">~</span>sep<span style="color: #990000">:(</span>item '<span style="color: #990000">-</span>'<span style="color: #990000">)</span> <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">3</span> <span style="color: #990000">(</span>item 'a'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">"a-aab"</span><span style="color: #990000">))</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"repetition: below min"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"a"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>repeat <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">3</span> <span style="color: #990000">(</span>item 'a'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">"aab"</span><span style="color: #990000">))</span> <span style="color: #990000">;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"a"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">2</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>repeat_greedy <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">3</span> <span style="color: #990000">(</span>item 'a'<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string <span style="color: #FF0000">"aab"</span><span style="color: #990000">))</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Some variants of <code>repeat</code> can now be defined:</p></div>
<div class="listingblock">
<div class="title">Parser library: repeat variants</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> several <span style="color: #990000">~</span>sep <span style="color: #990000">=</span> repeat <span style="color: #990000">~</span>sep <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span>
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> several_greedy <span style="color: #990000">~</span>sep <span style="color: #990000">=</span> repeat_greedy <span style="color: #990000">~</span>sep <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span>
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> times n <span style="color: #990000">=</span> repeat <span style="color: #990000">~</span>min<span style="color: #990000">:</span>n <span style="color: #990000">~</span>max<span style="color: #990000">:</span>n</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> several <span style="color: #990000">:</span> sep<span style="color: #990000">:</span>'d t <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>max<span style="color: #990000">:</span><span style="color: #009900">int</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>what<span style="color: #990000">:</span><span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #009900">list</span><span style="color: #990000">)</span> t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> several_greedy <span style="color: #990000">:</span> sep<span style="color: #990000">:</span>'z t <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>max<span style="color: #990000">:</span><span style="color: #009900">int</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>what<span style="color: #990000">:</span><span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #009900">list</span><span style="color: #990000">)</span> t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> times <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="color: #990000">-&gt;</span> sep<span style="color: #990000">:</span>'z t <span style="color: #990000">-&gt;</span> <span style="color: #990000">?</span>what<span style="color: #990000">:</span><span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b <span style="color: #009900">list</span><span style="color: #990000">)</span> t</tt></pre></div></div>
<div class="paragraph"><p>With all these new combinators, more interesting tests can be devised:</p></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"several combinators bound together"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> p <span style="color: #990000">=</span> decimal_digit <span style="color: #990000">&gt;&gt;=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> i <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code c <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code '<span style="color: #993399">0</span>' <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      assert_bool <span style="color: #FF0000">"not a digit"</span> <span style="color: #990000">(</span>i <span style="color: #990000">&gt;=</span> <span style="color: #993399">0</span> <span style="color: #990000">&amp;&amp;</span> i <span style="color: #990000">&lt;=</span> <span style="color: #993399">9</span><span style="color: #990000">)</span> <span style="color: #990000">;</span>
      <span style="font-style: italic"><span style="color: #9A1900">(* match a sequence of i zeros *)</span></span>
      times <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none i <span style="color: #990000">(</span>item '<span style="color: #993399">0</span>'<span style="color: #990000">))</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> rest1 <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"105"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> rest2 <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"100"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> rest3 <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"30005"</span>
    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> rest4 <span style="color: #990000">=</span> stream_of_string <span style="color: #FF0000">"3005"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[[</span>'<span style="color: #993399">0</span>'<span style="color: #990000">],</span> no_corr<span style="color: #990000">,</span> drop <span style="color: #993399">2</span> rest1<span style="color: #990000">])</span>
      <span style="color: #990000">(</span>p <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest1<span style="color: #990000">)</span> <span style="color: #990000">;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[[</span>'<span style="color: #993399">0</span>'<span style="color: #990000">],</span> no_corr<span style="color: #990000">,</span> drop <span style="color: #993399">2</span> rest2<span style="color: #990000">])</span>
      <span style="color: #990000">(</span>p <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest2<span style="color: #990000">)</span> <span style="color: #990000">;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[[</span>'<span style="color: #993399">0</span>'<span style="color: #990000">;</span>'<span style="color: #993399">0</span>'<span style="color: #990000">;</span>'<span style="color: #993399">0</span>'<span style="color: #990000">],</span> no_corr<span style="color: #990000">,</span> drop <span style="color: #993399">4</span> rest3<span style="color: #990000">])</span>
      <span style="color: #990000">(</span>p <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest3<span style="color: #990000">)</span> <span style="color: #990000">;</span>
    assert_same_results <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span>
      <span style="color: #990000">(</span><span style="color: #009900">Some</span> <span style="color: #FF0000">{</span> what <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"0"</span><span style="color: #990000">]</span> <span style="color: #990000">;</span> where <span style="color: #990000">=</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
      <span style="color: #990000">(</span>p <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr rest4<span style="color: #990000">)</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser library: trivial parsers and utilities</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> replace x _ <span style="color: #990000">=</span> x

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> anything <span style="color: #990000">?(</span>what<span style="color: #990000">=</span><span style="color: #FF0000">"anything"</span><span style="color: #990000">)</span> m e c s <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> what<span style="color: #990000">::</span>m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> pos<span style="color: #990000">,</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> _s' <span style="color: #990000">-&gt;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> <span style="color: #FF0000">"unexpected end of stream"</span><span style="color: #990000">::</span>m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> e' <span style="color: #990000">=</span> new_error pos m e <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      fail m e' c s
    <span style="color: #990000">|</span> _<span style="color: #990000">,</span> <span style="color: #009900">Item</span> tok<span style="color: #990000">,</span> s' <span style="color: #990000">-&gt;</span>
      return tok m e c s'<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that <code>anything</code> can only fail at end of input.</p></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> replace <span style="color: #990000">:</span> token <span style="color: #990000">-&gt;</span> 'b <span style="color: #990000">-&gt;</span> token
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> anything <span style="color: #990000">:</span> <span style="color: #990000">?</span>what<span style="color: #990000">:</span><span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> token t</tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_miscellaneous">8. Miscellaneous</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_improving_error_reporting">8.1. Improving error reporting</h3>
<div class="paragraph"><p>We have touched a bit on this topic earlier, when devising the alternate
function <code>oneof</code>: we make it so that when both alternative fails
<em>at_the_very_start</em> then the error reported is about the alternative not the
last failing term.  We also acknowledged that in some case this restriction
about failing right form the first token should be relaxed.</p></div>
<div class="paragraph"><p>We are now going to show a way to do this.</p></div>
<div class="paragraph"><p>Intuitively, some parser results are not significant unless they manage to parse
at least a sizeable amount of tokens. A first parser combinator that comes to mind
would thus, given a parser <code>p</code>, record the starting position and current best error
before trying <code>p</code> on the input. In case of p failing it could unwind the error
unless it meet some criteria, for instance that the position must have reached either
a minimum distance from the starting position or <code>EndOfStream</code>.</p></div>
<div class="listingblock">
<div class="title">Parser library: conditional dismissing of errors</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> dismiss_error_if cond p m e c s <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> start_err <span style="color: #990000">=</span> e <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  ct_bind <span style="color: #990000">(</span>p m e c s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>e'<span style="color: #990000">,</span> r <span style="font-weight: bold"><span style="color: #0000FF">as</span></span> res<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
    ct_bind <span style="color: #990000">(</span>take s<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>start_pos<span style="color: #990000">,</span> _<span style="color: #990000">,</span> _<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> e' <span style="color: #990000">&lt;&gt;</span> start_err <span style="color: #990000">&amp;&amp;</span> cond start_pos <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Option</span></span><span style="color: #990000">.</span>get e'<span style="color: #990000">).</span>where <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
        ct_return <span style="color: #990000">(</span>start_err<span style="color: #990000">,</span> r<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
        ct_return res<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;where <code>cond</code> is the condition dictating the dismissal of the new error, and
for which a simple implementation can be proposed that just considers how many
inputs have been successfully consumed before the failure:</p></div>
<div class="listingblock">
<div class="title">Parser library: convenience functions to judge error significance</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> parsed_fewer_than len pos1 pos2 <span style="color: #990000">=</span>
  distance pos1 pos2 <span style="color: #990000">&lt;</span> len</tt></pre></div></div>
<div class="paragraph"><p>Corresponding types have to be declared in the signature as well:</p></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> dismiss_error_if <span style="color: #990000">:</span> <span style="color: #990000">(</span>position <span style="color: #990000">-&gt;</span> position <span style="color: #990000">-&gt;</span> <span style="color: #009900">bool</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> 'a t <span style="color: #990000">-&gt;</span> 'a t
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> parsed_fewer_than <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="color: #990000">-&gt;</span> position <span style="color: #990000">-&gt;</span> position <span style="color: #990000">-&gt;</span> <span style="color: #009900">bool</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="type-generalization">8.2. Type generalization</h3>
<div class="paragraph"><p>Let&#8217;s get back to why we haven&#8217;t defined <code>none</code> simply as <code>let none = return
()</code>, letting automatic currying to lighten the syntax:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># let none = return ();;
             ^^^^^^^^^
Error: The type of this expression, ('_a, unit, '_b) t,
       contains type variables that cannot be generalized</code></pre>
</div></div>
<div class="paragraph"><p>This is actually a limitation of OCaml compiler. Here is what&#8217;s happening:
normally, in an expression like <code>let name = expr</code>, <code>expr</code> will be typed first,
leading in this case where <code>expr</code> is actually <code>return ()</code> to the type <code>(`_a,
unit, '_b) t</code> (where <code>'_a</code> and <code>'_b</code> are &#8220;weak types&#8221; (refer to the
definition of <code>return</code>: it&#8217;s merely a function of 3 parameters returning a list
of the triplet of these 3 parameters). Once <code>expr</code> is typed, OCaml follow this
rule: if <code>expr</code> is a function (as in <code>function &#8230; &#8594;</code>), a constant or an
identifier then generalize the weak types into universal types (the more
familiar <code>'a</code>, <code>'b</code> etc). If <code>erpx</code> is anything fancier, though, such as a
partial application as is the case here, then do not generalize.</p></div>
<div class="paragraph"><p>If instead we had <code>let name params&#8230; = expr</code> then, given it&#8217;s syntactic sugar
for <code>let name = function &#8230; &#8594; expr</code> then the &#8220;weak types&#8221; would have been
generalized.</p></div>
<div class="paragraph"><p>So we have to make this looks more like a function, by making explicit at least
one parameter (a process famously known under the tickling name
&#8220;eta-expansion&#8221;).</p></div>
<div class="paragraph"><p>This feels arbitrary because it is ; apparently this is one of the minor
disadvantage of a typing rules that has plenty of other advantages such as
simplifying something that&#8217;s already quite complex. See
<a href="https://caml.inria.fr/resources/doc/faq/core.en.html#eta-expansion">the OCaml FAQ</a>
for more details.</p></div>
<div class="paragraph"><p>This is unfortunately going to hit us a lot when defining parser combinators
because we&#8217;d like to get away with the many meaningless and repetitive
parameters which presence just obfuscate the intent of the code. C&#8217;est la vie.</p></div>
</div>
<div class="sect2">
<h3 id="_bounded_set">8.3. Bounded set</h3>
<div class="paragraph"><p>We still have to provide an implementation for our set of fixed maximum size.
The simplest implementation is that of a list with a current size:</p></div>
<div class="listingblock">
<div class="title">ParsersBoundedSet.ml: type</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a t <span style="color: #990000">=</span>
  <span style="color: #FF0000">{</span> size <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="color: #990000">;</span>
    max_size <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="color: #990000">;</span>
    items <span style="color: #990000">:</span> 'a <span style="color: #009900">list</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>With the trivial constructor:</p></div>
<div class="listingblock">
<div class="title">ParsersBoundedSet.ml: constructor</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> make max_size <span style="color: #990000">=</span>
  <span style="color: #FF0000">{</span> size <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #990000">;</span> max_size <span style="color: #990000">;</span> items <span style="color: #990000">=</span> <span style="color: #990000">[]</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>And the only three operations we&#8217;ve met so far:</p></div>
<div class="listingblock">
<div class="title">ParsersBoundedSet.ml: operations</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> is_full t <span style="color: #990000">=</span> t<span style="color: #990000">.</span>size <span style="color: #990000">&gt;=</span> t<span style="color: #990000">.</span>max_size
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> is_empty t <span style="color: #990000">=</span> t<span style="color: #990000">.</span>size <span style="color: #990000">=</span> <span style="color: #993399">0</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> add t x <span style="color: #990000">=</span>
  <span style="color: #FF0000">{</span> t <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> size <span style="color: #990000">=</span> t<span style="color: #990000">.</span>size <span style="color: #990000">+</span> <span style="color: #993399">1</span> <span style="color: #990000">;</span>
           items <span style="color: #990000">=</span> x<span style="color: #990000">::</span>t<span style="color: #990000">.</span>items <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>It would also be convenient to provide a simple shortcut in <code>Parsers</code> for
cases where no error detection is required:</p></div>
<div class="listingblock">
<div class="title">Parsers helpers: no error detection</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> no_error_correction <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>make <span style="color: #993399">0</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_printers">8.4. Printers</h3>
<div class="paragraph"><p>If there is something annoying about OCaml it&#8217;s the lack of default printers
for types. <code>Batteries</code> provides <code>dump</code> but it is oblivious to constructors so
the result is not pretty. So let&#8217;s write our own printers.</p></div>
<div class="paragraph"><p>It would be best to provide formatters instead of mere printers to benefit
from automatic typesetting but unfortunately <code>Batteries</code> support for those is
minimal so it&#8217;s better to forget about formatters to cut down on typing.</p></div>
<div class="paragraph"><p>First, parser configuration must supply printers of tokens, positions and
streams:</p></div>
<div class="listingblock">
<div class="title">Parser configuration:</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print_token <span style="color: #990000">:</span> 'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> token <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print_position <span style="color: #990000">:</span> 'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> position <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print_stream <span style="color: #990000">:</span> 'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> stream <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span></tt></pre></div></div>
<div class="paragraph"><p>With a printer for <code>ParsersBoundedSet.t</code> we could also print corrections:</p></div>
<div class="listingblock">
<div class="title">ParsersBoundedSet.ml: printer</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print print_value fmt t <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print print_value fmt t<span style="color: #990000">.</span>items</tt></pre></div></div>
<div class="listingblock">
<div class="title">ParsersMisc.ml: printer</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_stream_item print_token fmt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #009900">EndOfStream</span> <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>print fmt <span style="color: #FF0000">"end of input"</span>
  <span style="color: #990000">|</span> <span style="color: #009900">Item</span> c <span style="color: #990000">-&gt;</span> print_token fmt c</tt></pre></div></div>
<div class="listingblock">
<div class="title">ParsersCorrections.ml: printers</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_correction print_position print_token fmt <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> tok<span style="color: #990000">,</span> msg<span style="color: #990000">)</span> <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"%s at %a (near '%a')"</span>
    msg
    print_position pos
    <span style="color: #990000">(</span>print_stream_item print_token<span style="color: #990000">)</span> tok

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_corrections print_position print_token fmt corr <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #000080">ParsersBoundedSet</span></span><span style="color: #990000">.</span>print <span style="color: #990000">(</span>print_correction print_position print_token<span style="color: #990000">)</span> fmt corr</tt></pre></div></div>
<div class="paragraph"><p>With all this we can print errors and results:</p></div>
<div class="listingblock">
<div class="title">Parser library: printers</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_error_context fmt <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> cannot_find fmt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> <span style="color: #FF0000">"eof"</span> <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>print fmt <span style="color: #FF0000">"Was expecting end-of-file"</span>
    <span style="color: #990000">|</span> s <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"Cannot find %s"</span> s <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #990000">[]</span> <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>print fmt <span style="color: #FF0000">"No context known. This is bad. Good luck!"</span>
  <span style="color: #990000">|</span> <span style="color: #990000">[</span>x<span style="color: #990000">]</span> <span style="color: #990000">-&gt;</span>
    cannot_find fmt x
  <span style="color: #990000">|</span> <span style="color: #990000">[</span>x<span style="color: #990000">;</span> rest<span style="color: #990000">]</span> <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"%a while looking for %s"</span>
      cannot_find x rest
  <span style="color: #990000">|</span> x <span style="color: #990000">::</span> next <span style="color: #990000">::</span> rest <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"%a while looking for %s %a"</span>
      cannot_find x next
      <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="color: #990000">~</span>first<span style="color: #990000">:</span><span style="color: #FF0000">"(in "</span> <span style="color: #990000">~</span>last<span style="color: #990000">:</span><span style="color: #FF0000">")"</span> <span style="color: #990000">~</span>sep<span style="color: #990000">:</span><span style="color: #FF0000">" in "</span> <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>print<span style="color: #990000">)</span> rest

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_error fmt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"Ok"</span>
  <span style="color: #990000">|</span> <span style="color: #009900">Some</span> e <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"Error at %a: %a"</span>
      print_position e<span style="color: #990000">.</span>where
      print_error_context e<span style="color: #990000">.</span>what

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_possible_result print_output fmt <span style="color: #990000">(</span>x<span style="color: #990000">,</span> corr<span style="color: #990000">,</span> rest<span style="color: #990000">)</span> <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"(output=%a,corrections=%a,rest=%a)"</span>
    print_output x
    <span style="color: #990000">(</span>print_corrections print_position print_token<span style="color: #990000">)</span> corr
    print_stream rest

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_possible_results print_output fmt <span style="color: #990000">(</span>e<span style="color: #990000">,</span> r<span style="color: #990000">)</span> <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"%a, %a"</span>
    print_error e
    <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="color: #990000">(</span>print_possible_result print_output<span style="color: #990000">))</span> r

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_bad_result print_output fmt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #009900">Approximation</span> <span style="color: #990000">(</span>b<span style="color: #990000">,</span> c<span style="color: #990000">,</span> _s<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"Approximately: %a (corrections: %a)"</span>
      print_output b
      <span style="color: #990000">(</span>print_corrections print_position print_token<span style="color: #990000">)</span> c
  <span style="color: #990000">|</span> <span style="color: #009900">Ambiguous</span> lst <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"Ambiguous: %a"</span>
      <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>print <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> fmt <span style="color: #990000">(</span>b<span style="color: #990000">,</span> c<span style="color: #990000">,</span> _s<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
        <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"%a (corrections: %a)"</span>
          print_output b
          <span style="color: #990000">(</span>print_corrections print_position print_token<span style="color: #990000">)</span> c<span style="color: #990000">))</span> lst
  <span style="color: #990000">|</span> <span style="color: #009900">NoSolution</span> e <span style="color: #990000">-&gt;</span>
    print_error fmt e

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_result print_output fmt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #009900">Ok</span> <span style="color: #990000">(</span>b<span style="color: #990000">,</span> _s<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> print_output fmt b
  <span style="color: #990000">|</span> <span style="color: #009900">Bad</span> e <span style="color: #990000">-&gt;</span> print_bad_result print_output fmt e</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print_error <span style="color: #990000">:</span> 'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> error <span style="color: #009900">option</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print_possible_result <span style="color: #990000">:</span>
  <span style="color: #990000">(</span>'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> 'b <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
  'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span>
  'b possible_result <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print_possible_results <span style="color: #990000">:</span>
  <span style="color: #990000">(</span>'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> 'b <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
  'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span>
  <span style="color: #990000">(</span>error <span style="color: #009900">option</span> <span style="color: #990000">*</span> 'b possible_result <span style="color: #009900">list</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print_bad_result <span style="color: #990000">:</span>
  <span style="color: #990000">(</span>'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> 'b <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
  'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span>
  'b failure <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print_result <span style="color: #990000">:</span>
  <span style="color: #990000">(</span>'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> 'b <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span><span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
  'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span>
  <span style="color: #990000">(</span>'b <span style="color: #990000">*</span> stream<span style="color: #990000">,</span> 'b failure<span style="color: #990000">)</span> result <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_simple_string_scanners">8.5. Simple string scanners</h3>
<div class="paragraph"><p>Thanks to the <code>stream_of_string</code> function we can also devise a very simple to
use <code>of_string</code> function for any parser, that would come handy for testing
or other simple circumstances.</p></div>
<div class="listingblock">
<div class="title">Parser library: printers</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> of_string p str <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> s <span style="color: #990000">=</span> stream_of_string str <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  ct_bind
    <span style="color: #990000">((</span>p <span style="color: #990000">+-</span> eof<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_error_correction s <span style="color: #990000">|&gt;</span> to_result<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> <span style="color: #009900">Bad</span> e <span style="color: #990000">-&gt;</span> ct_return <span style="color: #990000">(</span><span style="color: #009900">Bad</span> e<span style="color: #990000">)</span>
    <span style="color: #990000">|</span> <span style="color: #009900">Ok</span> <span style="color: #990000">(</span>res<span style="color: #990000">,</span> _rest<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> ct_return <span style="color: #990000">(</span><span style="color: #009900">Ok</span> res<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that since we force the parser to reach the end of string we can discard
from the result the unparsed rest of the stream, which will always be empty.</p></div>
<div class="paragraph"><p>Simplifying further, this exception throwing variant will just return the
result without further ado. Notice that, for the sake of simplicity we don&#8217;t
force a <code>print_output</code> argument so the error report will not be as detailed as
the one given by <code>print_result</code>:</p></div>
<div class="listingblock">
<div class="title">Parser library: printers</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">exception</span></span> <span style="color: #009900">ParseError</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #009900">string</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> of_string_exn p str <span style="color: #990000">=</span>
  ct_bind <span style="color: #990000">(</span>of_string p str<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #009900">Bad</span> <span style="color: #990000">(</span><span style="color: #009900">Approximation</span> _<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> raise <span style="color: #990000">(</span><span style="color: #009900">ParseError</span> <span style="color: #FF0000">"Approximate result"</span><span style="color: #990000">)</span>
  <span style="color: #990000">|</span> <span style="color: #009900">Bad</span> <span style="color: #990000">(</span><span style="color: #009900">Ambiguous</span> _<span style="color: #990000">)</span>     <span style="color: #990000">-&gt;</span> raise <span style="color: #990000">(</span><span style="color: #009900">ParseError</span> <span style="color: #FF0000">"Ambiguous result"</span><span style="color: #990000">)</span>
  <span style="color: #990000">|</span> <span style="color: #009900">Bad</span> <span style="color: #990000">(</span><span style="color: #009900">NoSolution</span> e<span style="color: #990000">)</span>    <span style="color: #990000">-&gt;</span> raise <span style="color: #990000">(</span><span style="color: #009900">ParseError</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">IO</span></span><span style="color: #990000">.</span>to_string print_error e<span style="color: #990000">))</span>
  <span style="color: #990000">|</span> <span style="color: #009900">Ok</span> x <span style="color: #990000">-&gt;</span> ct_return x<span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">exception</span></span> <span style="color: #009900">ParseError</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #009900">string</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> of_string <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>'b<span style="color: #990000">,</span> 'b failure<span style="color: #990000">)</span> result ct
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> of_string_exn <span style="color: #990000">:</span> 'b t <span style="color: #990000">-&gt;</span> <span style="color: #009900">string</span> <span style="color: #990000">-&gt;</span> 'b ct</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_parsing_usual_things">9. Parsing usual things</h2>
<div class="sectionbody">
<div class="paragraph"><p>It might come handy to have some ready made parsers for common things such
as words, numbers, etc&#8230; We will regroup those in a <code>ParsersUsual</code> module
parametrized by a <code>Parsers</code> module for characters:</p></div>
<div class="listingblock">
<div class="title">ParsersUsual.ml: Parsers for usual things</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>
<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">Make</span> <span style="color: #990000">(</span><span style="color: #009900">P</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000080">Parsers</span></span><span style="color: #990000">.</span><span style="color: #009900">S</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="color: #009900">char</span><span style="color: #990000">)</span> <span style="color: #990000">=</span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
  <span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">P</span>
  <span style="font-style: italic"><span style="color: #9A1900">(* ...usual parsers... *)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;that we will test along with the <code>Parsers</code> module:</p></div>
<div class="listingblock">
<div class="title">other tested modules</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">SimpleUsual</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">ParsersUsual</span></span><span style="color: #990000">.</span><span style="color: #009900">Make</span> <span style="color: #990000">(</span><span style="color: #009900">P</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">SimpleUsual</span></tt></pre></div></div>
<div class="sect2">
<h3 id="_character_types">9.1. Character types</h3>
<div class="paragraph"><p>It is common to check for various classes of character: blanks, numerics,
alphanumerics, newlines&#8230;</p></div>
<div class="listingblock">
<div class="title">usual parsers: character classes</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> blank m <span style="color: #990000">=</span>
  cond <span style="color: #FF0000">"blank"</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span> c <span style="color: #990000">=</span> ' ' <span style="color: #990000">||</span> c <span style="color: #990000">=</span> '<span style="color: #990000">\</span>t'<span style="color: #990000">)</span> ' ' m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> carriage_return m <span style="color: #990000">=</span> item <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"carriage return"</span> '<span style="color: #990000">\</span>r' m
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> new_line m <span style="color: #990000">=</span> item <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"new line"</span> '<span style="color: #990000">\</span>n' m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> newline m <span style="color: #990000">=</span>
  <span style="color: #990000">(</span>optional <span style="color: #990000">~</span>def<span style="color: #990000">:</span>'<span style="color: #990000">\</span>r' carriage_return <span style="color: #990000">-+</span> new_line<span style="color: #990000">)</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> whitespace m <span style="color: #990000">=</span>
  repeat_greedy <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span> <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"whitespaces"</span> <span style="color: #990000">(</span>blank <span style="color: #990000">|||</span> newline<span style="color: #990000">)</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> opt_whitespace m <span style="color: #990000">=</span>
  optional_greedy <span style="color: #990000">~</span>def<span style="color: #990000">:[]</span> whitespace m</tt></pre></div></div>
<div class="paragraph"><p>Notice we read greedily the whitespaces because we want to avoid a <code>whitespace&#8201;&#8212;&#8201;whitespace</code> ambiguity. <code>optional_greedy</code> is there for the same reason.</p></div>
<div class="listingblock">
<div class="title">usual parsers: more character classes</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> lowercase m <span style="color: #990000">=</span> range 'a' 'z' <span style="color: #FF0000">"lowercase"</span> m
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> uppercase m <span style="color: #990000">=</span> range '<span style="color: #009900">A</span>' '<span style="color: #009900">Z</span>' <span style="color: #FF0000">"uppercase"</span> m
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> letter m <span style="color: #990000">=</span> <span style="color: #990000">(</span>lowercase <span style="color: #990000">|||</span> uppercase<span style="color: #990000">)</span> m
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> decimal_digit m <span style="color: #990000">=</span> range '<span style="color: #993399">0</span>' '<span style="color: #993399">9</span>' <span style="color: #FF0000">"digit"</span> m
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> alphanum m <span style="color: #990000">=</span> <span style="color: #990000">(</span>letter <span style="color: #990000">|||</span> decimal_digit<span style="color: #990000">)</span> m</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_strings">9.2. Strings</h3>
<div class="paragraph"><p>Starting from the <code>char</code> parser that&#8217;s an <code>item</code> specialized in characters:</p></div>
<div class="listingblock">
<div class="title">usual parsers: chars</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> quoted s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>sprintf <span style="color: #FF0000">"%S"</span> s

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #009900">char</span> <span style="color: #990000">?</span>what <span style="color: #990000">?(</span>case_sensitive<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">)</span> c <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> other_case c <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>is_lowercase c <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>uppercase c <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>is_uppercase c <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>lowercase c <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> c <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> c' <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> case_sensitive <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> c <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> other_case c <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> expl <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">Option</span></span><span style="color: #990000">.</span>default_delayed <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">()</span> <span style="color: #990000">-&gt;</span> quoted <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>of_char c<span style="color: #990000">))</span> what <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  cond expl <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> x <span style="color: #990000">-&gt;</span> x <span style="color: #990000">=</span> c <span style="color: #990000">||</span> x <span style="color: #990000">=</span> c'<span style="color: #990000">)</span> c</tt></pre></div></div>
<div class="paragraph"><p>&#8230;the parser matching a given string can be written:</p></div>
<div class="listingblock">
<div class="title">usual parsers: strings</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">ParsersMisc</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="color: #009900">string</span> <span style="color: #990000">?</span>case_sensitive s <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> loop i <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> i <span style="color: #990000">&gt;=</span> <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>length s <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> return <span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #990000">(</span>
      <span style="color: #990000">(</span><span style="color: #009900">char</span> <span style="color: #990000">~</span>what<span style="color: #990000">:(</span>quoted s<span style="color: #990000">)</span> <span style="color: #990000">?</span>case_sensitive s<span style="color: #990000">.[</span>i<span style="color: #990000">])</span> <span style="color: #990000">--</span> <span style="color: #990000">(</span>loop <span style="color: #990000">(</span>i<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">))</span>
    <span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  loop <span style="color: #993399">0</span></tt></pre></div></div>
<div class="paragraph"><p>One often wants to parse string literals (represented as C-like quoted strings):</p></div>
<div class="listingblock">
<div class="title">usual parsers: quoted strings</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> quoted_char <span style="color: #990000">?(</span>base_num<span style="color: #990000">=</span><span style="color: #993399">8</span><span style="color: #990000">)</span> <span style="color: #990000">?(</span>what<span style="color: #990000">=</span><span style="color: #FF0000">"character"</span><span style="color: #990000">)</span> <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> digit base_num <span style="color: #990000">=</span> cond_map <span style="color: #FF0000">"digit"</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> check n <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> n <span style="color: #990000">&gt;=</span> <span style="color: #993399">0</span> <span style="color: #990000">&amp;&amp;</span> n <span style="color: #990000">&lt;</span> base_num <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="color: #009900">Some</span> n <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #009900">None</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> c <span style="color: #990000">&gt;=</span> '<span style="color: #993399">0</span>' <span style="color: #990000">&amp;&amp;</span> c <span style="color: #990000">&lt;=</span> '<span style="color: #993399">9</span>' <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> check <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code c <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code '<span style="color: #993399">0</span>'<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> c <span style="color: #990000">&gt;=</span> 'a' <span style="color: #990000">&amp;&amp;</span> c <span style="color: #990000">&lt;=</span> 'z' <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> check <span style="color: #990000">(</span><span style="color: #993399">10</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code c <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code 'a'<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> c <span style="color: #990000">&gt;=</span> '<span style="color: #009900">A</span>' <span style="color: #990000">&amp;&amp;</span> c <span style="color: #990000">&lt;=</span> '<span style="color: #009900">Z</span>' <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> check <span style="color: #990000">(</span><span style="color: #993399">10</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code c <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code '<span style="color: #009900">A</span>'<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
    <span style="color: #009900">None</span><span style="color: #990000">)</span> <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> hexdigit <span style="color: #990000">=</span> digit <span style="color: #993399">16</span> <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> digit <span style="color: #990000">=</span> digit base_num
  <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="color: #009900">char</span> <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"escape sequence"</span> '<span style="color: #990000">\\</span>' <span style="color: #990000">-+</span>
    <span style="color: #990000">((</span>cond_map <span style="color: #FF0000">"escaped character"</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
     <span style="color: #990000">|</span> 'n' <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> '<span style="color: #990000">\</span>n'  <span style="color: #990000">|</span> 'r' <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> '<span style="color: #990000">\</span>r'  <span style="color: #990000">|</span> 'b' <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> '<span style="color: #990000">\</span>b'
     <span style="color: #990000">|</span> 't' <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> '<span style="color: #990000">\</span>t'  <span style="color: #990000">|</span> '<span style="color: #990000">\\</span>' <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> '<span style="color: #990000">\\</span>' <span style="color: #990000">|</span> '<span style="color: #FF0000">"' -&gt; Some '"</span>'
     <span style="color: #990000">|</span> '<span style="color: #990000">\</span>'' <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> '<span style="color: #990000">\</span>''
     <span style="color: #990000">|</span> c <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="color: #990000">(</span>c <span style="color: #990000">&lt;</span> '<span style="color: #993399">0</span>' <span style="color: #990000">||</span> c <span style="color: #990000">&gt;</span> '<span style="color: #993399">9</span>'<span style="color: #990000">)</span> <span style="color: #990000">&amp;&amp;</span> c <span style="color: #990000">&lt;&gt;</span> 'x' <span style="color: #990000">-&gt;</span> <span style="color: #009900">Some</span> c
     <span style="color: #990000">|</span> _ <span style="color: #990000">-&gt;</span> <span style="color: #009900">None</span><span style="color: #990000">)</span> 'n'<span style="color: #990000">)</span> <span style="color: #990000">|||</span>
    <span style="color: #990000">(</span><span style="font-style: italic"><span style="color: #9A1900">(* numeric escape sequence of 3 digits in base base_num: *)</span></span>
     repeat <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"numeric escape sequence"</span> <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">3</span> <span style="color: #990000">~</span>max<span style="color: #990000">:</span><span style="color: #993399">3</span> digit <span style="color: #990000">&gt;&gt;:</span>
       <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> lst <span style="color: #990000">-&gt;</span>
         <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> n <span style="color: #990000">=</span>
           <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>fold_left <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> s c <span style="color: #990000">-&gt;</span> s <span style="color: #990000">*</span> base_num <span style="color: #990000">+</span> c<span style="color: #990000">)</span> <span style="color: #993399">0</span> lst <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
         <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>chr n<span style="color: #990000">)</span> <span style="color: #990000">|||</span>
    <span style="color: #990000">(</span><span style="font-style: italic"><span style="color: #9A1900">(* hexanumeric escape sequence: *)</span></span>
     <span style="color: #009900">char</span> <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"x"</span> 'x' <span style="color: #990000">-+</span>
     repeat <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"hexanumeric escape sequence"</span> <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">2</span> <span style="color: #990000">~</span>max<span style="color: #990000">:</span><span style="color: #993399">2</span> hexdigit <span style="color: #990000">&gt;&gt;:</span>
       <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> lst <span style="color: #990000">-&gt;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> n <span style="color: #990000">=</span>
          <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>fold_left <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> s c <span style="color: #990000">-&gt;</span> s <span style="color: #990000">*</span> <span style="color: #993399">16</span> <span style="color: #990000">+</span> c<span style="color: #990000">)</span> <span style="color: #993399">0</span> lst <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>chr n<span style="color: #990000">))</span> <span style="color: #990000">|||</span>
  cond what <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span> c <span style="color: #990000">&lt;&gt;</span> '<span style="color: #990000">\\</span>' <span style="color: #990000">&amp;&amp;</span> c <span style="color: #990000">&lt;&gt;</span> '"'<span style="color: #990000">)</span> 'x'

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> quoted_string <span style="color: #990000">?</span>base_num <span style="color: #990000">=</span>
  <span style="color: #009900">char</span> <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"opening quote"</span> '"' <span style="color: #990000">-+</span>
  repeat_greedy <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"a quoted string"</span> <span style="color: #990000">(</span>quoted_char <span style="color: #990000">?</span>base_num<span style="color: #990000">)</span> <span style="color: #990000">+-</span>
  <span style="color: #009900">char</span> <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"closing quote"</span> '"' <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>of_list</tt></pre></div></div>
<div class="paragraph"><p>Notice that if the base for the numeric escape sequence is greater than 10 we
cannot be sure any longer how to parse "\b" for instance.</p></div>
<div class="paragraph"><p>With some tests for good measure:</p></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"quoted strings"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">[</span> <span style="color: #FF0000">"\"abc\""</span><span style="color: #990000">,</span> <span style="color: #FF0000">"abc"</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"\"\\x61\\x62\\x63\""</span><span style="color: #990000">,</span> <span style="color: #FF0000">"abc"</span> <span style="color: #990000">]</span> <span style="color: #990000">|&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>iter <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>input<span style="color: #990000">,</span> output<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      assert_same_results <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>print
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>output<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>length input<span style="color: #990000">,</span> <span style="color: #990000">[])])</span>
        <span style="color: #990000">((</span>quoted_string <span style="color: #990000">+-</span> eof<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string input<span style="color: #990000">)))</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Another usual offender is parsing C like identifiers (aka any words made of characters,
numbers or underscore but not starting by a number):</p></div>
<div class="listingblock">
<div class="title">usual parsers: identifier</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> underscore m <span style="color: #990000">=</span> item <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"underscore"</span> '_' m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> identifier <span style="color: #990000">?(</span>what<span style="color: #990000">=</span><span style="color: #FF0000">"identifier"</span><span style="color: #990000">)</span> <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> first_char <span style="color: #990000">=</span> letter <span style="color: #990000">|||</span> underscore <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> any_char <span style="color: #990000">=</span> first_char <span style="color: #990000">|||</span> decimal_digit <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  first_char <span style="color: #990000">++</span> repeat_greedy <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>what any_char <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>c<span style="color: #990000">,</span> s<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>of_list <span style="color: #990000">(</span>c <span style="color: #990000">::</span> s<span style="color: #990000">)</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_numbers">9.3. Numbers</h3>
<div class="paragraph"><p>We will try to follow the most common conventions for parsing numbers.
Notice that a simple base 10 integer number must start with a non 0
(otherwise it&#8217;s octal).  We make no exception for the single digit <em>0</em> which
will be parsed as octal.</p></div>
<div class="paragraph"><p>We use the <code>Num</code> module from the standard library to represent arbitrary
integers as we use it only to store the representation of numbers (if we
cared about efficiency of arithmetic operations we would use <code>zarith</code>).</p></div>
<div class="listingblock">
<div class="title">usual parsers: integers</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> integer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> non_zero_decimal_digit m <span style="color: #990000">=</span>
  range '<span style="color: #993399">1</span>' '<span style="color: #993399">9</span>' <span style="color: #FF0000">"non-zero digit"</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> num_of_char c <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> cc <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code c <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> cc <span style="color: #990000">&gt;=</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code '<span style="color: #993399">0</span>' <span style="color: #990000">&amp;&amp;</span> cc <span style="color: #990000">&lt;=</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code '<span style="color: #993399">9</span>' <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #990000">(</span>cc <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code '<span style="color: #993399">0</span>'<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> cc <span style="color: #990000">&gt;=</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code 'a' <span style="color: #990000">&amp;&amp;</span> cc <span style="color: #990000">&lt;=</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code 'f' <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #990000">(</span>cc <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code 'a' <span style="color: #990000">+</span> <span style="color: #993399">10</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> cc <span style="color: #990000">&gt;=</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code '<span style="color: #009900">A</span>' <span style="color: #990000">&amp;&amp;</span> cc <span style="color: #990000">&lt;=</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code '<span style="color: #009900">F</span>' <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #990000">(</span>cc <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>code '<span style="color: #009900">A</span>' <span style="color: #990000">+</span> <span style="color: #993399">10</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> invalid_arg <span style="color: #FF0000">"c"</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> unsigned_decimal_number <span style="color: #990000">?</span>what <span style="color: #990000">?(</span>inc_zero<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">)</span> m <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ten <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">10</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> m <span style="color: #990000">=</span> may_add_context m what <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> digits m <span style="color: #990000">=</span> several <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none decimal_digit m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="color: #990000">((</span><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> inc_zero <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> decimal_digit <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> non_zero_decimal_digit<span style="color: #990000">)</span> <span style="color: #990000">+-</span>
   optional <span style="color: #990000">~</span>def<span style="color: #990000">:</span>' ' underscore <span style="color: #990000">++</span>
   optional <span style="color: #990000">~</span>def<span style="color: #990000">:[]</span> <span style="color: #990000">(</span>several <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>underscore digits<span style="color: #990000">)</span> <span style="color: #990000">+-</span>
   nay decimal_digit <span style="color: #990000">&gt;&gt;:</span>
   <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>first<span style="color: #990000">,</span> next<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
   <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>fold_left <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c digits <span style="color: #990000">-&gt;</span>
     <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>fold_left <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c digit <span style="color: #990000">-&gt;</span>
       <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>add <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>mul c ten<span style="color: #990000">)</span> <span style="color: #990000">(</span>num_of_char digit<span style="color: #990000">))</span> c digits<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>zero <span style="color: #990000">([</span>first<span style="color: #990000">]::</span>next<span style="color: #990000">))</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> signed neg p <span style="color: #990000">=</span>
  p                                <span style="color: #990000">|||</span>
  item <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"sign"</span> '<span style="color: #990000">+</span>' <span style="color: #990000">-+</span> p       <span style="color: #990000">|||</span>
  <span style="color: #990000">(</span>item <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"sign"</span> '<span style="color: #990000">-</span>' <span style="color: #990000">-+</span> p <span style="color: #990000">&gt;&gt;:</span> neg<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> decimal_number <span style="color: #990000">?(</span>inc_zero<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">)</span> m <span style="color: #990000">=</span>
  signed <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>minus_num <span style="color: #990000">(</span>unsigned_decimal_number <span style="color: #990000">~</span>inc_zero<span style="color: #990000">)</span> m</tt></pre></div></div>
<div class="paragraph"><p>with the help of:</p></div>
<div class="listingblock">
<div class="title">ParsersMisc.ml: helper for enriching context</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> may_add_context m <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span> m
  <span style="color: #990000">|</span> <span style="color: #009900">Some</span> w <span style="color: #990000">-&gt;</span> w<span style="color: #990000">::</span>m</tt></pre></div></div>
<div class="paragraph"><p>We have made <code>num_of_char</code> accept hexadecimal digits in foresight.</p></div>
<div class="paragraph"><p>Octals, hexadecimal and binary numbers are then build similarly: a mandatory
prefix, and some digits interleaved with underscores. Notice that only the
prefix is mandatory and <em>0x</em> for instance is a valid immediate (representing
zero of course), as in the Perl language.</p></div>
<div class="listingblock">
<div class="title">usual parsers: non decimal integers</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> non_decimal_integer base prefix digit <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> base <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int base <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> digits m <span style="color: #990000">=</span> several_greedy <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none digit m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  prefix <span style="color: #990000">-+</span> repeat <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>underscore <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"digits"</span> digits <span style="color: #990000">&gt;&gt;:</span>
     <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>fold_left <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c digits <span style="color: #990000">-&gt;</span>
       <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>fold_left <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c digit <span style="color: #990000">-&gt;</span>
         <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>add <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>mul c base<span style="color: #990000">)</span> <span style="color: #990000">(</span>num_of_char digit<span style="color: #990000">))</span> c digits<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>zero

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> octal_digit m <span style="color: #990000">=</span>
  range '<span style="color: #993399">0</span>' '<span style="color: #993399">7</span>' <span style="color: #FF0000">"octal digit"</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> octal_number m <span style="color: #990000">=</span>
  <span style="color: #990000">(</span>non_decimal_integer <span style="color: #993399">8</span> <span style="color: #990000">(</span>item '<span style="color: #993399">0</span>'<span style="color: #990000">)</span> octal_digit <span style="color: #990000">|&gt;</span>
   signed <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>minus_num<span style="color: #990000">)</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> hexadecimal_digit m <span style="color: #990000">=</span>
  cond <span style="color: #FF0000">"hexadecimal digit"</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">(</span>c <span style="color: #990000">&gt;=</span> '<span style="color: #993399">0</span>' <span style="color: #990000">&amp;&amp;</span> c <span style="color: #990000">&lt;=</span> '<span style="color: #993399">9</span>'<span style="color: #990000">)</span> <span style="color: #990000">||</span>
    <span style="color: #990000">(</span>c <span style="color: #990000">&gt;=</span> 'a' <span style="color: #990000">&amp;&amp;</span> c <span style="color: #990000">&lt;=</span> 'f'<span style="color: #990000">)</span> <span style="color: #990000">||</span>
    <span style="color: #990000">(</span>c <span style="color: #990000">&gt;=</span> '<span style="color: #009900">A</span>' <span style="color: #990000">&amp;&amp;</span> c <span style="color: #990000">&lt;=</span> '<span style="color: #009900">F</span>'<span style="color: #990000">))</span> '<span style="color: #993399">1</span>' m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> non_decimal_integer_prefix x <span style="color: #990000">=</span>
  item '<span style="color: #993399">0</span>' <span style="color: #990000">--</span>
  cond <span style="color: #FF0000">"integer prefix"</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>lowercase c <span style="color: #990000">=</span> x<span style="color: #990000">)</span> x

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> hexadecimal_number m <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> prefix <span style="color: #990000">=</span> non_decimal_integer_prefix 'x' <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="color: #990000">(</span>non_decimal_integer <span style="color: #993399">16</span> prefix hexadecimal_digit <span style="color: #990000">|&gt;</span>
   signed <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>minus_num<span style="color: #990000">)</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> binary_digit m <span style="color: #990000">=</span>
  range '<span style="color: #993399">0</span>' '<span style="color: #993399">1</span>' <span style="color: #FF0000">"bit"</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> binary_number m <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> prefix <span style="color: #990000">=</span> non_decimal_integer_prefix 'b' <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="color: #990000">(</span>non_decimal_integer <span style="color: #993399">2</span> prefix binary_digit <span style="color: #990000">|&gt;</span>
   signed <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>minus_num<span style="color: #990000">)</span> m</tt></pre></div></div>
<div class="paragraph"><p>Finally, this parser can parse all kinds of integers seen so far:</p></div>
<div class="listingblock">
<div class="title">usual parsers: any integer</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> integer m <span style="color: #990000">=</span>
  <span style="color: #990000">(</span>decimal_number <span style="color: #990000">~</span>inc_zero<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="color: #990000">|||</span>
   octal_number                   <span style="color: #990000">|||</span>
   hexadecimal_number             <span style="color: #990000">|||</span>
   binary_number<span style="color: #990000">)</span> m</tt></pre></div></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"integer immediate"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">[</span> <span style="color: #FF0000">"4"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">4</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"42"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">42</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"12345"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">12345</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"4_294_967_296"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int 4_294_967_296 <span style="color: #990000">;</span>
      <span style="color: #FF0000">"042"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int 0o42 <span style="color: #990000">;</span>
      <span style="color: #FF0000">"0x42"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">0x42</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"0X42"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">0x42</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"0xff"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">0xff</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"0b10"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int 0b10 <span style="color: #990000">;</span>
      <span style="color: #FF0000">"0x"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">0</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"0x4_2"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int 0x4_2 <span style="color: #990000">;</span>
      <span style="color: #FF0000">"-4"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #990000">~-</span><span style="color: #993399">4</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"+4"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">4</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"-042"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #990000">~-</span>0o42 <span style="color: #990000">;</span>
      <span style="color: #FF0000">"+042"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int 0o42 <span style="color: #990000">;</span>
      <span style="color: #FF0000">"-0x42"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #990000">~-</span><span style="color: #993399">0x42</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"-0b10"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #990000">~-</span>0b10 <span style="color: #990000">]</span> <span style="color: #990000">|&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>iter <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>input<span style="color: #990000">,</span> output<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      assert_same_results <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>print
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>output<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>length input<span style="color: #990000">,</span> <span style="color: #990000">[])])</span>
        <span style="color: #990000">((</span>integer <span style="color: #990000">+-</span> eof<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string input<span style="color: #990000">)))</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span>
<span style="color: #FF0000">"not decimal number immediate"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">[</span> <span style="color: #FF0000">"0_"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">"0X_"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">"_123"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">"123_"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">"12__34"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">"_"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">"_0x123"</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"-0_"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">"-_42"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">"+"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">"-"</span> <span style="color: #990000">;</span> <span style="color: #FF0000">""</span> <span style="color: #990000">]</span> <span style="color: #990000">|&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>iter <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> input <span style="color: #990000">-&gt;</span>
      assert_same_results <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>print
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[])</span>
        <span style="color: #990000">((</span>integer <span style="color: #990000">+-</span> eof<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string input<span style="color: #990000">)))</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>The syntax for floating point numbers is more <em>perly</em>.  Indeed, in additional
to the usual decimal and scientific notations, Perl allows hexadecimal floating
point, with a power of two as the exponent (and a "p" instead of an "e" to
introduce the exponent, for obvious reason).</p></div>
<div class="paragraph"><p>Also, notice that you can omit either the integer or the fractional part but
not both.</p></div>
<div class="listingblock">
<div class="title">usual parsers: floating point</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> fractional_part inv_base digit <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> digits m <span style="color: #990000">=</span> several <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none digit m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  several <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>underscore digits <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> digits <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>fold_left <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c_scale digits <span style="color: #990000">-&gt;</span>
        <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>fold_left <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>c<span style="color: #990000">,</span> scale<span style="color: #990000">)</span> digit <span style="color: #990000">-&gt;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> n <span style="color: #990000">=</span> num_of_char digit <span style="color: #990000">|&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>to_float <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
            c <span style="color: #990000">+.</span> n <span style="color: #990000">*.</span> scale<span style="color: #990000">,</span> scale <span style="color: #990000">*.</span> inv_base
          <span style="color: #990000">)</span> c_scale digits
      <span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">.,</span> inv_base<span style="color: #990000">)</span> digits <span style="color: #990000">|&gt;</span>
    fst

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> unsigned_decimal_fractional m <span style="color: #990000">=</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> dot m <span style="color: #990000">=</span> item <span style="color: #990000">~</span>what<span style="color: #990000">:</span><span style="color: #FF0000">"fractional dot"</span> '<span style="color: #990000">.</span>' m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
  <span style="color: #990000">((</span>unsigned_decimal_number <span style="color: #990000">+-</span> dot <span style="color: #990000">++</span> fractional_part <span style="color: #993399">0.1</span> decimal_digit<span style="color: #990000">)</span> <span style="color: #990000">|||</span>
   <span style="color: #990000">(</span>return <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>zero <span style="color: #990000">+-</span> dot <span style="color: #990000">++</span> fractional_part <span style="color: #993399">0.1</span> decimal_digit<span style="color: #990000">)</span>                <span style="color: #990000">|||</span>
   <span style="color: #990000">(</span>unsigned_decimal_number <span style="color: #990000">+-</span> dot <span style="color: #990000">++</span> return <span style="color: #993399">0</span><span style="color: #990000">.)</span> <span style="color: #990000">&gt;&gt;:</span>
       <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>n<span style="color: #990000">,</span> p<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>to_float n <span style="color: #990000">+.</span> p
  <span style="color: #990000">)</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> decimal_fractional m <span style="color: #990000">=</span>
  signed <span style="font-weight: bold"><span style="color: #000080">Float</span></span><span style="color: #990000">.</span>neg unsigned_decimal_fractional m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> decimal_scientific m <span style="color: #990000">=</span>
  <span style="color: #990000">((</span>decimal_fractional <span style="color: #990000">|||</span>
    <span style="color: #990000">(</span>decimal_number <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>to_float<span style="color: #990000">))</span> <span style="color: #990000">+-</span>
   cond <span style="color: #FF0000">"exponent delimiter"</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span> c <span style="color: #990000">=</span> 'e' <span style="color: #990000">||</span> c <span style="color: #990000">=</span> '<span style="color: #009900">E</span>'<span style="color: #990000">)</span> 'e' <span style="color: #990000">++</span>
   decimal_number <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>m<span style="color: #990000">,</span> e<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
     m <span style="color: #990000">*.</span> <span style="font-weight: bold"><span style="color: #000080">Float</span></span><span style="color: #990000">.</span>pow <span style="color: #993399">10</span><span style="color: #990000">.</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>to_float e<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">(* FIXME *)</span></span>
   <span style="color: #990000">)</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> floating_point m <span style="color: #990000">=</span>
  <span style="color: #990000">(</span>decimal_fractional <span style="color: #990000">|||</span>
   decimal_scientific<span style="color: #990000">)</span> m</tt></pre></div></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"floating point notation"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">[</span> <span style="color: #FF0000">"3.14"</span><span style="color: #990000">,</span> <span style="color: #993399">3.14</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"-3.14"</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">3.14</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"314e2"</span><span style="color: #990000">,</span> <span style="color: #993399">31400</span><span style="color: #990000">.</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"314e-2"</span><span style="color: #990000">,</span> <span style="color: #993399">3.14</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">".1"</span><span style="color: #990000">,</span> <span style="color: #993399">0.1</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"1."</span><span style="color: #990000">,</span> <span style="color: #993399">1.0</span> <span style="color: #990000">]</span> <span style="color: #990000">|&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>iter <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>input<span style="color: #990000">,</span> output<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      assert_same_results <span style="font-weight: bold"><span style="color: #000080">Float</span></span><span style="color: #990000">.</span>print
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>output<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>length input<span style="color: #990000">,</span> <span style="color: #990000">[])])</span>
        <span style="color: #990000">((</span>floating_point <span style="color: #990000">+-</span> eof<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr <span style="color: #990000">(</span>stream_of_string input<span style="color: #990000">)))</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>And finally the parser of any immediate number:</p></div>
<div class="listingblock">
<div class="title">usual parsers: any number</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> number <span style="color: #990000">=</span> <span style="color: #009900">Int</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> integer
            <span style="color: #990000">|</span> <span style="color: #009900">Float</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #009900">float</span>
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> number m <span style="color: #990000">=</span>
  <span style="color: #990000">((</span>integer        <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> x <span style="color: #990000">-&gt;</span> <span style="color: #009900">Int</span> x<span style="color: #990000">)</span> <span style="color: #990000">|||</span>
   <span style="color: #990000">(</span>floating_point <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> x <span style="color: #990000">-&gt;</span> <span style="color: #009900">Float</span> x<span style="color: #990000">))</span> m</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_operations">9.4. Operations</h3>
<div class="paragraph"><p>Operators are another frequent occurrence. Of course how to parse an
"operation" is likely to depend on the problem at hand, but it&#8217;s still useful
to discuss them here if only to demonstrate how to deal with recursive rules.</p></div>
<div class="paragraph"><p>Indeed, the straightforward way to define a parser for operations would rely on
left recursion, which a combinatoric parser can not perform. Instead, we will
have to <em>force</em> <em>progress</em> by defining a chain of terms and subterms in order
of precedence.</p></div>
<div class="paragraph"><p>The principle of such a chain is to replace a left recursing definition such
as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> term m <span style="color: #990000">=</span> <span style="color: #990000">(</span>term <span style="color: #990000">+-</span> any_binary_op <span style="color: #990000">++</span> term<span style="color: #990000">)</span> m</tt></pre></div></div>
<div class="paragraph"><p>with:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> term1 m <span style="color: #990000">=</span> <span style="color: #990000">((</span>term2 <span style="color: #990000">+-</span> low_precedence_op <span style="color: #990000">++</span> term2<span style="color: #990000">)</span> <span style="color: #990000">|||</span> term2<span style="color: #990000">)</span> m
<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> term2 m <span style="color: #990000">=</span> <span style="color: #990000">((</span>term3 <span style="color: #990000">+-</span> higher_precedence_op <span style="color: #990000">++</span> term3<span style="color: #990000">)</span> <span style="color: #990000">|||</span> term3<span style="color: #990000">)</span> m
<span style="font-style: italic"><span style="color: #9A1900">(* etc... *)</span></span></tt></pre></div></div>
<div class="paragraph"><p>Allowing recursion only after some input have been consumed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> this_is_ok m <span style="color: #990000">=</span>
  <span style="color: #990000">(</span>item '<span style="color: #FF0000">{</span>' <span style="color: #990000">-+</span> this_is_ok <span style="color: #990000">++</span> item '<span style="color: #FF0000">}</span>'<span style="color: #990000">)</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> this_is_infinite_recursion m <span style="color: #990000">=</span>
  <span style="color: #990000">(</span>this_is_infinite_recursion <span style="color: #990000">++</span> anything_else<span style="color: #990000">)</span> m

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> this_is_still_infinite_recursion m <span style="color: #990000">=</span>
  <span style="color: #990000">(</span>check some_check <span style="color: #990000">++</span>
   this_is_still_infinite_recursion<span style="color: #990000">)</span> m</tt></pre></div></div>
<div class="paragraph"><p>Now this chain will always parse left side first. If <code>1 + 2 * 3</code> will properly
be parsed as <code>1 + (2 * 3)</code> (because the parse would fail if <code>term1</code> consumed
only <code>1 + 2</code>), the simple <code>3 - 2 - 1</code> would be erroneously parsed as <code>3 - (2 -
1)</code> instead of <code>(3 - 2) - 1</code>. To help with left associative operators, we need
to group operators of same precedence and associativity and use a <code>repeat</code>
parser, which associativity we are free to choose.</p></div>
<div class="paragraph"><p>Here is a <code>binary_ops_reducer</code> parser that takes a parser for binary operators
of same associativity and precedence (here called <code>op</code>), and a parser for terms
(called <code>term</code>), and returns either the left or right associativity parser. It
is expected that the <code>term</code> parser has higher precedence than <code>op</code>. It bears
some resemblance with <code>repeat</code> but does not discard the output of the separator
(here: the operation) and build as a last stage the final result out of the
list of partial results, with the expected associativity.  This situation
occurs often enough in practice that it&#8217;s worth having a generic solution in
the parser combinator library. It is made generic enough by the use of another
parameter, the <code>reduce</code> function, that combines two terms and an operator
results into a value of the same type as returned by term. Notice that this may
force the user of this <code>binary_ops_reducer</code> function to <code>lift</code> the sub-term
parser in order to return a singleton term instead (if the sub-terms and terms
do not share a common type).</p></div>
<div class="listingblock">
<div class="title">Parser library: binary operations with selected associativity</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">let</span></span> binary_ops_reducer <span style="color: #990000">?(</span>right_associative<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">)</span> <span style="color: #990000">~</span>op <span style="color: #990000">~</span>term <span style="color: #990000">~</span>sep <span style="color: #990000">~</span>reduce <span style="color: #990000">=</span>
  term <span style="color: #990000">++</span> optional_greedy <span style="color: #990000">~</span>def<span style="color: #990000">:[]</span> <span style="color: #990000">(</span>sep <span style="color: #990000">-+</span> repeat <span style="color: #990000">~</span>min<span style="color: #990000">:</span><span style="color: #993399">1</span> <span style="color: #990000">~</span>sep <span style="color: #990000">(</span>op <span style="color: #990000">+-</span> sep <span style="color: #990000">++</span> term<span style="color: #990000">))</span> <span style="color: #990000">&gt;&gt;:</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>fst<span style="color: #990000">,</span> lst<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="font-style: italic"><span style="color: #9A1900">(* lst is a list of (op result * term result) *)</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> loop_lst last_term <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
      <span style="color: #990000">|</span> <span style="color: #990000">[]</span> <span style="color: #990000">-&gt;</span> last_term
      <span style="color: #990000">|</span> <span style="color: #990000">(</span>op<span style="color: #990000">,</span> next_term<span style="color: #990000">)::</span>rest <span style="color: #990000">-&gt;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> right_associative <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
          reduce last_term op <span style="color: #990000">(</span>loop_lst next_term rest<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
          loop_lst <span style="color: #990000">(</span>reduce last_term op next_term<span style="color: #990000">)</span> rest
        <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    loop_lst fst lst</tt></pre></div></div>
<div class="listingblock">
<div class="title">Parser signature</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">val</span></span> binary_ops_reducer <span style="color: #990000">:</span>
  <span style="color: #990000">?</span>right_associative<span style="color: #990000">:</span><span style="color: #009900">bool</span> <span style="color: #990000">-&gt;</span>
  op<span style="color: #990000">:</span>'o t <span style="color: #990000">-&gt;</span>
  term<span style="color: #990000">:</span>'b t <span style="color: #990000">-&gt;</span>
  sep<span style="color: #990000">:</span><span style="color: #009900">unit</span> t <span style="color: #990000">-&gt;</span>
  reduce<span style="color: #990000">:(</span>'b <span style="color: #990000">-&gt;</span> 'o <span style="color: #990000">-&gt;</span> 'b <span style="color: #990000">-&gt;</span> 'b<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
  'b t</tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s see it in action:</p></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"binary_ops_reducer"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> term m <span style="color: #990000">=</span> <span style="color: #990000">(</span>decimal_digit <span style="color: #990000">&gt;&gt;:</span> <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> c <span style="color: #990000">-&gt;</span> <span style="color: #009900">Term</span> c<span style="color: #990000">)</span> m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> op m <span style="color: #990000">=</span> item '<span style="color: #990000">+</span>' m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> reduce t1 _op t2 <span style="color: #990000">=</span> <span style="color: #009900">Op</span> <span style="color: #990000">(</span>t1<span style="color: #990000">,</span> t2<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="color: #990000">[</span> <span style="color: #FF0000">"1+2"</span><span style="color: #990000">,</span>
        <span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Term</span> '<span style="color: #993399">1</span>'<span style="color: #990000">,</span> <span style="color: #009900">Term</span> '<span style="color: #993399">2</span>'<span style="color: #990000">),</span>
        <span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Term</span> '<span style="color: #993399">1</span>'<span style="color: #990000">,</span> <span style="color: #009900">Term</span> '<span style="color: #993399">2</span>'<span style="color: #990000">)</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"1+2+3"</span><span style="color: #990000">,</span>
        <span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Term</span> '<span style="color: #993399">1</span>'<span style="color: #990000">,</span> <span style="color: #009900">Term</span> '<span style="color: #993399">2</span>'<span style="color: #990000">),</span> <span style="color: #009900">Term</span> '<span style="color: #993399">3</span>'<span style="color: #990000">),</span>
        <span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Term</span> '<span style="color: #993399">1</span>'<span style="color: #990000">,</span> <span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Term</span> '<span style="color: #993399">2</span>'<span style="color: #990000">,</span> <span style="color: #009900">Term</span> '<span style="color: #993399">3</span>'<span style="color: #990000">))</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"1+2+3+4"</span><span style="color: #990000">,</span>
        <span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Term</span> '<span style="color: #993399">1</span>'<span style="color: #990000">,</span> <span style="color: #009900">Term</span> '<span style="color: #993399">2</span>'<span style="color: #990000">),</span> <span style="color: #009900">Term</span> '<span style="color: #993399">3</span>'<span style="color: #990000">),</span> <span style="color: #009900">Term</span> '<span style="color: #993399">4</span>'<span style="color: #990000">),</span>
        <span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Term</span> '<span style="color: #993399">1</span>'<span style="color: #990000">,</span> <span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Term</span> '<span style="color: #993399">2</span>'<span style="color: #990000">,</span> <span style="color: #009900">Op</span> <span style="color: #990000">(</span><span style="color: #009900">Term</span> '<span style="color: #993399">3</span>'<span style="color: #990000">,</span> <span style="color: #009900">Term</span> '<span style="color: #993399">4</span>'<span style="color: #990000">)))</span> <span style="color: #990000">]</span> <span style="color: #990000">|&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>iter <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>input_str<span style="color: #990000">,</span> exp1<span style="color: #990000">,</span> exp2<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      <span style="font-style: italic"><span style="color: #9A1900">(* exp1 is the expected result for left associative parsing and</span></span>
<span style="font-style: italic"><span style="color: #9A1900">         exp2 for right associative parsing. *)</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> input <span style="color: #990000">=</span> stream_of_string input_str <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      assert_same_results <span style="color: #990000">~</span>msg<span style="color: #990000">:</span><span style="color: #FF0000">"left assoc."</span> binary_ops_reducer_test_result_print
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>exp1<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>length input_str<span style="color: #990000">,</span> <span style="color: #990000">[])])</span>
        <span style="color: #990000">((</span>binary_ops_reducer <span style="color: #990000">~</span>op <span style="color: #990000">~</span>term <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>reduce <span style="color: #990000">~</span>right_associative<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
          <span style="color: #990000">+-</span> eof<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr input<span style="color: #990000">)</span> <span style="color: #990000">;</span>
      assert_same_results <span style="color: #990000">~</span>msg<span style="color: #990000">:</span><span style="color: #FF0000">"right assoc."</span> binary_ops_reducer_test_result_print
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>exp2<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>length input_str<span style="color: #990000">,</span> <span style="color: #990000">[])])</span>
        <span style="color: #990000">((</span>binary_ops_reducer <span style="color: #990000">~</span>op <span style="color: #990000">~</span>term <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>reduce <span style="color: #990000">~</span>right_associative<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
          <span style="color: #990000">+-</span> eof<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr input<span style="color: #990000">))</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>with type <code>binary_ops_reducer_test_result</code> defined globally, as required by OCaml:</p></div>
<div class="listingblock">
<div class="title">other global functions or types for testing</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> binary_ops_reducer_test_result <span style="color: #990000">=</span>
    <span style="color: #009900">Term</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="font-weight: bold"><span style="color: #000080">Char</span></span><span style="color: #990000">.</span>t
  <span style="color: #990000">|</span> <span style="color: #009900">Op</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #990000">(</span>binary_ops_reducer_test_result <span style="color: #990000">*</span>
           binary_ops_reducer_test_result<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> binary_ops_reducer_test_result_print fmt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
  <span style="color: #990000">|</span> <span style="color: #009900">Term</span> c <span style="color: #990000">-&gt;</span>
     <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"%c"</span> c
  <span style="color: #990000">|</span> <span style="color: #009900">Op</span> <span style="color: #990000">(</span>r1<span style="color: #990000">,</span> r2<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
     <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"(%a+%a)"</span>
       binary_ops_reducer_test_result_print r1
       binary_ops_reducer_test_result_print r2</tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s also test the handling of precedence with a small calculator:</p></div>
<div class="listingblock">
<div class="title">tests</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">"precedence and associativity"</span> <span style="color: #990000">&gt;::</span> <span style="color: #990000">(</span>
  <span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> _ctx <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> value m <span style="color: #990000">=</span> <span style="color: #990000">(</span>decimal_digit <span style="color: #990000">&gt;&gt;:</span> num_of_char<span style="color: #990000">)</span> m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> reduce t1 op t2 <span style="color: #990000">=</span>
      <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> op <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> op <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
        <span style="color: #990000">|</span> '<span style="color: #990000">+</span>' <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>add <span style="color: #990000">|</span> '<span style="color: #990000">-</span>' <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>sub
        <span style="color: #990000">|</span> '<span style="color: #990000">*</span>' <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>mul <span style="color: #990000">|</span> '<span style="color: #990000">/</span>' <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>div
        <span style="color: #990000">|</span> '<span style="color: #990000">^</span>' <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>pow <span style="color: #990000">|</span> _ <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">assert</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      op t1 t2 <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> left_assoc_low_prec m <span style="color: #990000">=</span>
      binary_ops_reducer <span style="color: #990000">~</span>op<span style="color: #990000">:(</span>item '<span style="color: #990000">+</span>' <span style="color: #990000">|||</span> item '<span style="color: #990000">-</span>'<span style="color: #990000">)</span>
                         <span style="color: #990000">~</span>term<span style="color: #990000">:</span>left_assoc_high_prec
                         <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>reduce m
    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> left_assoc_high_prec m <span style="color: #990000">=</span>
      binary_ops_reducer <span style="color: #990000">~</span>op<span style="color: #990000">:(</span>item '<span style="color: #990000">*</span>' <span style="color: #990000">|||</span> item '<span style="color: #990000">/</span>'<span style="color: #990000">)</span>
                         <span style="color: #990000">~</span>term<span style="color: #990000">:</span>right_assoc_higher_prec
                         <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>reduce m
    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> right_assoc_higher_prec m <span style="color: #990000">=</span>
      binary_ops_reducer <span style="color: #990000">~</span>op<span style="color: #990000">:(</span>item '<span style="color: #990000">^</span>'<span style="color: #990000">)</span>
                         <span style="color: #990000">~</span>right_associative<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
                         <span style="color: #990000">~</span>term<span style="color: #990000">:</span>left_assoc_highest_prec
                         <span style="color: #990000">~</span>sep<span style="color: #990000">:</span>none <span style="color: #990000">~</span>reduce m
    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> left_assoc_highest_prec m <span style="color: #990000">=</span>
      <span style="color: #990000">(</span>value <span style="color: #990000">|||</span>
       item '<span style="color: #990000">(</span>' <span style="color: #990000">-+</span> left_assoc_low_prec <span style="color: #990000">+-</span> item '<span style="color: #990000">)</span>'<span style="color: #990000">)</span> m <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="color: #990000">[</span> <span style="color: #FF0000">"0"</span><span style="color: #990000">,</span>       <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">0</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"1+2"</span><span style="color: #990000">,</span>     <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">3</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"1+2+3"</span><span style="color: #990000">,</span>   <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">6</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"1+2+3+4"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">10</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"5-1"</span><span style="color: #990000">,</span>     <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">4</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"5-4-1"</span><span style="color: #990000">,</span>   <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">0</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"(5-4)-1"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">0</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"5-(4-1)"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">2</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"4^3^2"</span><span style="color: #990000">,</span>   <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">262144</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"4^(3^2)"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">262144</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"(4^3)^2"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">4096</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"3*2+1"</span><span style="color: #990000">,</span>   <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">7</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"1+3*2"</span><span style="color: #990000">,</span>   <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">7</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"(1+3)*2"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">8</span> <span style="color: #990000">;</span>
      <span style="color: #FF0000">"8/2/2"</span><span style="color: #990000">,</span>   <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>num_of_int <span style="color: #993399">2</span> <span style="color: #990000">]</span> <span style="color: #990000">|&gt;</span>
    <span style="font-weight: bold"><span style="color: #000080">List</span></span><span style="color: #990000">.</span>iter <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="color: #990000">(</span>input_str<span style="color: #990000">,</span> exp<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> input <span style="color: #990000">=</span> stream_of_string input_str <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
      assert_same_results <span style="font-weight: bold"><span style="color: #000080">Num</span></span><span style="color: #990000">.</span>print
        <span style="color: #990000">(</span><span style="color: #009900">None</span><span style="color: #990000">,</span> <span style="color: #990000">[</span>exp<span style="color: #990000">,</span> no_corr<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>length input_str<span style="color: #990000">,</span> <span style="color: #990000">[])])</span>
        <span style="color: #990000">((</span>left_assoc_low_prec <span style="color: #990000">+-</span> eof<span style="color: #990000">)</span> <span style="color: #990000">[]</span> <span style="color: #009900">None</span> no_corr input<span style="color: #990000">))</span>
<span style="color: #990000">)</span> <span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Hopefully this example shed some confidence on parsing operators with any precedence and
associativity despite using parser combinators.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configurations">10. Configurations</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here are provided some <code>Parsers.CONFIG</code> implementing more complex parsers
than the <code>SimpleConfig</code> (that was tailored for unit tests) and a few simple
position types ɣ.</p></div>
<div class="sect2">
<h3 id="_turning_destructive_reads_into_persistent_streams">10.1. Turning destructive reads into persistent streams</h3>
<div class="paragraph"><p>Let&#8217;s define a proper persistent stream type adapted to networking.</p></div>
<div class="paragraph"><p>The stream should take its tokens from blocs chained together. Reception of a
new block should append it at the end of the list (the pointer to the <code>next</code>
block must be mutable), in such a way that when all streams are done with the
first block of the chain no more pointers point to it and it can be reclaimed
by the garbage collector.</p></div>
<div class="paragraph"><p>Most of the times we will want bytes in there, but for generality we must
provide streams of token. We will therefore ask for another configuration
module providing the actual token container (maybe a <code>Buffer.t</code>, a <code>bytes</code>, an
array or any indexed container) with a <code>nth</code> function returning the token at
some designated index. This configuration module must also provide the function
returning the (promise of a) next block (and the range we ought to parse). To
limit functorization in end user code we will assume that this function also
takes some additional parameter representing the channel that is being read
(such as a file descriptor).</p></div>
<div class="listingblock">
<div class="title">ParsersConfig.ml: turn a destructive stream into a persistent one</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>
<span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">ParsersMisc</span>

<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> <span style="color: #009900">CONFIG</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">sig</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">(* ...threading types... *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> print_token <span style="color: #990000">:</span> 'o <span style="font-weight: bold"><span style="color: #000080">BatInnerIO</span></span><span style="color: #990000">.</span>output <span style="color: #990000">-&gt;</span> token <span style="color: #990000">-&gt;</span> <span style="color: #009900">unit</span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> buf
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> nth <span style="color: #990000">:</span> buf <span style="color: #990000">-&gt;</span> <span style="color: #009900">int</span> <span style="color: #990000">-&gt;</span> token
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> channel
  <span style="font-weight: bold"><span style="color: #0000FF">val</span></span> read_buf <span style="color: #990000">:</span> channel <span style="color: #990000">-&gt;</span> <span style="color: #990000">(</span>buf <span style="color: #990000">*</span> <span style="color: #009900">int</span> <span style="color: #990000">*</span> <span style="color: #009900">int</span><span style="color: #990000">)</span> <span style="color: #009900">option</span> ct
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">BlockList</span> <span style="color: #990000">(</span><span style="color: #009900">Conf</span> <span style="color: #990000">:</span> <span style="color: #009900">CONFIG</span><span style="color: #990000">)</span> <span style="color: #990000">=</span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
  <span style="font-weight: bold"><span style="color: #000080">include</span></span> <span style="color: #009900">Conf</span>

  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> block <span style="color: #990000">=</span>
    <span style="color: #FF0000">{</span> buffer <span style="color: #990000">:</span> buf <span style="color: #990000">;</span>
      first <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">(* <img alt="1" src="data:image/png;base64,
iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAAAAABzHgM7AAAAAmJLR0QAAKqNIzIAAABjSURBVHja
VY6xDcAwCAS/pPQaLim9QmajdOk2I2SNrMEIlARIoigU8Cek/4e7zdHaWOYOVwaoA6wOCw05Y7FB
gE0tIWQ+sBcwKM8qoD/wB5wGL8hjfdzWrh01GRp1hInGjDoXwHgsFuzBVLQAAABDdEVYdFNvZnR3
YXJlAEAoIylJbWFnZU1hZ2ljayA0LjIuOCA5OS8wOC8wMSBjcmlzdHlAbXlzdGljLmVzLmR1cG9u
dC5jb22RuiG4AAAAKnRFWHRTaWduYXR1cmUANThhMDcyZTA3MGRhMjJmNjEzNWNiZDNlNDE0NTQ2
ZjloaiHtAAAADnRFWHRQYWdlADEyeDEyKzArMIRtu30AAAAASUVORK5CYII=" /> *)</span></span>
      last <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">mutable</span></span> next_block <span style="color: #990000">:</span> block <span style="color: #009900">option</span> <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> stream <span style="color: #990000">=</span> <span style="color: #009900">Unstarted</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #FF0000">{</span> channel <span style="color: #990000">:</span> channel <span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">mutable</span></span> first_block <span style="color: #990000">:</span> block <span style="color: #009900">option</span> <span style="color: #FF0000">}</span>
              <span style="color: #990000">|</span> <span style="color: #009900">Started</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span> <span style="color: #FF0000">{</span> channel <span style="color: #990000">:</span> channel <span style="color: #990000">;</span> block <span style="color: #990000">:</span> block <span style="color: #990000">;</span> next <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="font-style: italic"><span style="color: #9A1900">(* <img alt="2" src="data:image/png;base64,
iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAAAAABzHgM7AAAAAmJLR0QAAKqNIzIAAAB7SURBVHja
HY6hFcMwDEQ/NDQsNSwU9Apdo7Cw0CsIBoZmhKzQEQJLDQsFVclHpHu693W429Zr7bu541Pg3kCm
Y0K75u9TEUPhuGgWU4mQDvieEaSQEnsT6zKPeZY0EUNtrHMCXvYUuSUg0PsMjUSvpysUT6OOSil9
izp/VNk1YJ8vf6MAAABDdEVYdFNvZnR3YXJlAEAoIylJbWFnZU1hZ2ljayA0LjIuOCA5OS8wOC8w
MSBjcmlzdHlAbXlzdGljLmVzLmR1cG9udC5jb22RuiG4AAAAKnRFWHRTaWduYXR1cmUAODBlYWU1
MjljOTRhN2Y0N2RlY2NmYWRhMjhhY2I5ZGblb7ENAAAADnRFWHRQYWdlADEyeDEyKzArMIRtu30A
AAAASUVORK5CYII=" /> *)</span></span> <span style="color: #FF0000">}</span>
              <span style="color: #990000">|</span> <span style="color: #009900">Finished</span>

  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> make_stream channel <span style="color: #990000">=</span>
    <span style="color: #009900">Unstarted</span> <span style="color: #FF0000">{</span> channel <span style="color: #990000">;</span> first_block <span style="color: #990000">=</span> <span style="color: #009900">None</span> <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_stream fmt <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> <span style="color: #009900">Unstarted</span> _ <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"Unstarted"</span>
    <span style="color: #990000">|</span> <span style="color: #009900">Started</span> _  <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"TODO"</span>
    <span style="color: #990000">|</span> <span style="color: #009900">Finished</span> <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"EOF"</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img alt="1" src="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAAAAABzHgM7AAAAAmJLR0QAAKqNIzIAAABjSURBVHja
VY6xDcAwCAS/pPQaLim9QmajdOk2I2SNrMEIlARIoigU8Cek/4e7zdHaWOYOVwaoA6wOCw05Y7FB
gE0tIWQ+sBcwKM8qoD/wB5wGL8hjfdzWrh01GRp1hInGjDoXwHgsFuzBVLQAAABDdEVYdFNvZnR3
YXJlAEAoIylJbWFnZU1hZ2ljayA0LjIuOCA5OS8wOC8wMSBjcmlzdHlAbXlzdGljLmVzLmR1cG9u
dC5jb22RuiG4AAAAKnRFWHRTaWduYXR1cmUANThhMDcyZTA3MGRhMjJmNjEzNWNiZDNlNDE0NTQ2
ZjloaiHtAAAADnRFWHRQYWdlADEyeDEyKzArMIRtu30AAAAASUVORK5CYII=" /></td><td>
These first and last indexes are fixed. They tell us where in the buffer
we should start and stop reading ; this is not the stream pointer!
</td></tr>
<tr><td><img alt="2" src="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAAAAABzHgM7AAAAAmJLR0QAAKqNIzIAAAB7SURBVHja
HY6hFcMwDEQ/NDQsNSwU9Apdo7Cw0CsIBoZmhKzQEQJLDQsFVclHpHu693W429Zr7bu541Pg3kCm
Y0K75u9TEUPhuGgWU4mQDvieEaSQEnsT6zKPeZY0EUNtrHMCXvYUuSUg0PsMjUSvpysUT6OOSil9
izp/VNk1YJ8vf6MAAABDdEVYdFNvZnR3YXJlAEAoIylJbWFnZU1hZ2ljayA0LjIuOCA5OS8wOC8w
MSBjcmlzdHlAbXlzdGljLmVzLmR1cG9udC5jb22RuiG4AAAAKnRFWHRTaWduYXR1cmUAODBlYWU1
MjljOTRhN2Y0N2RlY2NmYWRhMjhhY2I5ZGblb7ENAAAADnRFWHRQYWdlADEyeDEyKzArMIRtu30A
AAAASUVORK5CYII=" /></td><td>
This is the stream pointer.
</td></tr>
</table></div>
<div class="paragraph"><p>Notice that the chain of blocks is not persistent (because of the mutable
next pointer) but the stream itself is: a stream can be copied and reused
later regardless of what other copies are doing.</p></div>
<div class="paragraph"><p>So the stream reader can either read the next available token (wrapped into a
<code>ct</code>) or wait until the next buffer to be ready:</p></div>
<div class="listingblock">
<div class="title">ParsersConfig.ml: The take function</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> <span style="font-weight: bold"><span style="color: #0000FF">rec</span></span> take <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
    <span style="color: #990000">|</span> <span style="color: #009900">Finished</span> <span style="font-weight: bold"><span style="color: #0000FF">as</span></span> s <span style="color: #990000">-&gt;</span>
      ct_return <span style="color: #990000">((),</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> s<span style="color: #990000">)</span>
    <span style="color: #990000">|</span> <span style="color: #009900">Started</span> s <span style="font-weight: bold"><span style="color: #0000FF">as</span></span> stream <span style="color: #990000">-&gt;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> s<span style="color: #990000">.</span>next <span style="color: #990000">&lt;</span> s<span style="color: #990000">.</span>block<span style="color: #990000">.</span>last <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
        ct_return <span style="color: #990000">(</span>
          <span style="color: #990000">(),</span>
          <span style="color: #009900">Item</span> <span style="color: #990000">(</span>nth s<span style="color: #990000">.</span>block<span style="color: #990000">.</span>buffer s<span style="color: #990000">.</span>next<span style="color: #990000">),</span>
          <span style="color: #009900">Started</span> <span style="color: #FF0000">{</span> s <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> next <span style="color: #990000">=</span> s<span style="color: #990000">.</span>next<span style="color: #990000">+</span><span style="color: #993399">1</span> <span style="color: #FF0000">}</span><span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #990000">(</span>
        <span style="font-weight: bold"><span style="color: #0000FF">match</span></span> s<span style="color: #990000">.</span>block<span style="color: #990000">.</span>next_block <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
        <span style="color: #990000">|</span> <span style="color: #009900">Some</span> block <span style="color: #990000">-&gt;</span>
          take <span style="color: #990000">(</span><span style="color: #009900">Started</span> <span style="color: #FF0000">{</span> s <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> block <span style="color: #990000">=</span> block <span style="color: #990000">;</span> next <span style="color: #990000">=</span> block<span style="color: #990000">.</span>first <span style="color: #FF0000">}</span><span style="color: #990000">)</span>
        <span style="color: #990000">|</span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>This is the problematic case. We have to request the next block, and add it to
the chain of blocks so that other streams lagging behind us could also parse
it in the future. Notice that given <code>read_buf</code> is a blocking operation other
threads could (and hopefully will) run while we wait. But none of those are
competing parsers : despite we use threads to freeze the parsing at no point
are we actually having more than one parsing thread ; nowhere in the library
have we spawned a new thread, and all other existing streams are in this
thread own stack. This is not to say that one can not run two parsers
simultaneously but then, of course, they will have to parse different streams.
In other words, nothing else in the running program must be calling our
<code>read_buf</code> or we will miss some blocks. Hopefully that&#8217;s obvious enough that
nobody will try to do that.</p></div>
<div class="paragraph"><p>So let&#8217;s call <code>read_buf</code> and wait, confident that nothing bad will happen:</p></div>
<div class="listingblock">
<div class="title">ParsersConfig.ml: take next token from next block</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>          ct_bind <span style="color: #990000">(</span>read_buf s<span style="color: #990000">.</span>channel<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
          <span style="color: #990000">|</span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span>
            ct_return <span style="color: #990000">((),</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> <span style="color: #009900">Finished</span><span style="color: #990000">)</span>
          <span style="color: #990000">|</span> <span style="color: #009900">Some</span> <span style="color: #990000">(</span>buffer<span style="color: #990000">,</span> first<span style="color: #990000">,</span> last<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> next_block <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> buffer <span style="color: #990000">;</span> first <span style="color: #990000">;</span> last <span style="color: #990000">;</span>
                               next_block <span style="color: #990000">=</span> <span style="color: #009900">None</span> <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span></tt></pre></div></div>
<div class="paragraph"><p>Of course it costs nothing to check the above assumption:</p></div>
<div class="listingblock">
<div class="title">ParsersConfig.ml: enqueue this block for laggers and retry</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>            <span style="font-weight: bold"><span style="color: #0000FF">assert</span></span> <span style="color: #990000">(</span>s<span style="color: #990000">.</span>block<span style="color: #990000">.</span>next_block <span style="color: #990000">=</span> <span style="color: #009900">None</span><span style="color: #990000">)</span> <span style="color: #990000">;</span>
            s<span style="color: #990000">.</span>block<span style="color: #990000">.</span>next_block <span style="color: #990000">&lt;-</span> <span style="color: #009900">Some</span> next_block <span style="color: #990000">;</span>
            take stream
        <span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The case where the stream is not started yet is interesting: this stream has to
be shareable as well, but we must have only one instance of the pointer to the
next block (so that when one instance triggers the actual read all other
instances can find the data) and we do not want to keep a pointer to the head
of the list forever (we want the list to be garbage collected). So we merely
have the mutable address of the optional first block.</p></div>
<div class="listingblock">
<div class="title">ParsersConfig.ml: take from the head of the stream</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="color: #990000">|</span> <span style="color: #009900">Unstarted</span> u <span style="font-weight: bold"><span style="color: #0000FF">as</span></span> stream <span style="color: #990000">-&gt;</span>
      <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">match</span></span> u<span style="color: #990000">.</span>first_block <span style="font-weight: bold"><span style="color: #0000FF">with</span></span>
      <span style="color: #990000">|</span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span>
        ct_bind <span style="color: #990000">(</span>read_buf u<span style="color: #990000">.</span>channel<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
        <span style="color: #990000">|</span> <span style="color: #009900">None</span> <span style="color: #990000">-&gt;</span>
          ct_return <span style="color: #990000">((),</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> <span style="color: #009900">Finished</span><span style="color: #990000">)</span>
        <span style="color: #990000">|</span> <span style="color: #009900">Some</span> <span style="color: #990000">(</span>buffer<span style="color: #990000">,</span> first<span style="color: #990000">,</span> last<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span>
          <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> next_block <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> buffer <span style="color: #990000">;</span> first <span style="color: #990000">;</span> last <span style="color: #990000">;</span>
                             next_block <span style="color: #990000">=</span> <span style="color: #009900">None</span> <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">assert</span></span> <span style="color: #990000">(</span>u<span style="color: #990000">.</span>first_block <span style="color: #990000">=</span> <span style="color: #009900">None</span><span style="color: #990000">)</span> <span style="color: #990000">;</span>
          u<span style="color: #990000">.</span>first_block <span style="color: #990000">&lt;-</span> <span style="color: #009900">Some</span> next_block <span style="color: #990000">;</span>
          take stream<span style="color: #990000">)</span>
      <span style="color: #990000">|</span> <span style="color: #009900">Some</span> block <span style="color: #990000">-&gt;</span>
        take <span style="color: #990000">(</span><span style="color: #009900">Started</span> <span style="color: #FF0000">{</span> channel <span style="color: #990000">=</span> u<span style="color: #990000">.</span>channel <span style="color: #990000">;</span> block <span style="color: #990000">;</span> next <span style="color: #990000">=</span> block<span style="color: #990000">.</span>first <span style="color: #FF0000">}</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>We can now add a few more definitions in there so that this BlockList look more
like a Parsers.CONFIG:</p></div>
<div class="listingblock">
<div class="title">ParsersConfig.ml: turning it into an actual Parsers CONFIG</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> position <span style="color: #990000">=</span> <span style="color: #009900">unit</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> distance <span style="color: #990000">()</span> <span style="color: #990000">()</span> <span style="color: #990000">=</span> <span style="color: #993399">0</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_position fmt <span style="color: #990000">()</span> <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">String</span></span><span style="color: #990000">.</span>print fmt <span style="color: #FF0000">"some location"</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream_of_string _str <span style="color: #990000">=</span>
    failwith <span style="color: #FF0000">"Not implemented"</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_lwt">10.2. LWT</h3>
<div class="paragraph"><p><code>LWT</code> already provides a <code>Lwt_stream.t</code> type for streams, that you would expect
to be persistent given the threading context. But actually those are
destructive, therefore useless for us. Let&#8217;s use instead the list of blocks
constructed above. Here is an example implementation that reads bytes from a
file descriptor:</p></div>
<div class="listingblock">
<div class="title">ParsersLwtConfig.ml: file parsers for LWT</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>

<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">FileReader</span> <span style="color: #990000">:</span>
  <span style="font-weight: bold"><span style="color: #000080">ParsersConfig</span></span><span style="color: #990000">.</span><span style="color: #009900">CONFIG</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="color: #009900">char</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>t
                        <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> channel <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt_unix</span></span><span style="color: #990000">.</span>file_descr <span style="color: #990000">=</span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">(* Lwt bindings: *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>t
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_bind <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>bind
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_return <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>return

  <span style="font-style: italic"><span style="color: #9A1900">(* Reading characters: *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="color: #009900">char</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_token fmt c <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"%C"</span> c

  <span style="font-style: italic"><span style="color: #9A1900">(* From a file: *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> buf <span style="color: #990000">=</span> bytes
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> nth <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Bytes</span></span><span style="color: #990000">.</span>get
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> channel <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt_unix</span></span><span style="color: #990000">.</span>file_descr
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> read_buf channel <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> max_len <span style="color: #990000">=</span> <span style="color: #993399">1024</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> buf <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Bytes</span></span><span style="color: #990000">.</span>create max_len <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span><span style="color: #990000">%</span>lwt r <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt_unix</span></span><span style="color: #990000">.</span>read channel buf <span style="color: #993399">0</span> max_len <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>return <span style="color: #990000">(</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> r <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="color: #009900">None</span>
      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #009900">Some</span> <span style="color: #990000">(</span>buf<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> r<span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you prefer <code>Lwt_io</code> channels instead:</p></div>
<div class="listingblock">
<div class="title">ParsersLwtConfig.ml: file parsers for LWT channels</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">ChannelReader</span> <span style="color: #990000">:</span>
  <span style="font-weight: bold"><span style="color: #000080">ParsersConfig</span></span><span style="color: #990000">.</span><span style="color: #009900">CONFIG</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="color: #009900">char</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>t
                        <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> channel <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt_io</span></span><span style="color: #990000">.</span>input_channel <span style="color: #990000">=</span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">(* Same Lwt bindings as above: *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>t
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_bind <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>bind
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_return <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>return

  <span style="font-style: italic"><span style="color: #9A1900">(* And same tokens *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="color: #009900">char</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_token fmt c <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"%C"</span> c

  <span style="font-style: italic"><span style="color: #9A1900">(* Same byte buffers: *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> buf <span style="color: #990000">=</span> bytes
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> nth <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Bytes</span></span><span style="color: #990000">.</span>get

  <span style="font-style: italic"><span style="color: #9A1900">(* But now we read from a Lwt_io.input_channel: *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> channel <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt_io</span></span><span style="color: #990000">.</span>input_channel
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> read_buf channel <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> max_len <span style="color: #990000">=</span> <span style="color: #993399">1024</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> buf <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Bytes</span></span><span style="color: #990000">.</span>create max_len <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span><span style="color: #990000">%</span>lwt r <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Lwt_io</span></span><span style="color: #990000">.</span>read_into channel buf <span style="color: #993399">0</span> max_len <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #000080">Lwt</span></span><span style="color: #990000">.</span>return <span style="color: #990000">(</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> r <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="color: #009900">None</span>
      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #009900">Some</span> <span style="color: #990000">(</span>buf<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> r<span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_blocking_unix_config">10.3. Blocking Unix CONFIG</h3>
<div class="paragraph"><p>This configuration assumes that it is OK to block when reading tokens (assuming
the parser runs in its own POSIX thread for instance). It&#8217;s given as a
configuration a mere <code>in_channel</code> from which bytes (tokens) will be read.</p></div>
<div class="listingblock">
<div class="title">ParsersConfig.ml: Reading a file using normal blocking Unix read</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>

<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">FileReader</span> <span style="color: #990000">:</span>
  <span style="color: #009900">CONFIG</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="color: #009900">char</span>
          <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a
          <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> channel <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Unix</span></span><span style="color: #990000">.</span>file_descr <span style="color: #990000">=</span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">(* No continuation passing trickery needed: *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_bind x f <span style="color: #990000">=</span> f x
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_return x <span style="color: #990000">=</span> x

  <span style="font-style: italic"><span style="color: #9A1900">(* Reading characters: *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="color: #009900">char</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_token fmt c <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"%C"</span> c

  <span style="font-style: italic"><span style="color: #9A1900">(* From a file: *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> buf <span style="color: #990000">=</span> bytes
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> nth <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Bytes</span></span><span style="color: #990000">.</span>get
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> channel <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Unix</span></span><span style="color: #990000">.</span>file_descr
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> read_buf channel <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> max_len <span style="color: #990000">=</span> <span style="color: #993399">1024</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> buf <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Bytes</span></span><span style="color: #990000">.</span>create max_len <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> r <span style="color: #990000">=</span>
      <span style="font-weight: bold"><span style="color: #000080">Unix</span></span><span style="color: #990000">.(</span>
        <span style="font-weight: bold"><span style="color: #0000FF">try</span></span>
          restart_on_EINTR <span style="color: #990000">(</span>read channel buf <span style="color: #993399">0</span><span style="color: #990000">)</span> max_len
        <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="color: #009900">Unix_error</span><span style="color: #990000">(</span><span style="color: #009900">ECONNRESET</span><span style="color: #990000">,</span> _<span style="color: #990000">,</span> _<span style="color: #990000">)</span> <span style="color: #990000">-&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> r <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="color: #009900">None</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #009900">Some</span> <span style="color: #990000">(</span>buf<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> r<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_positioning_in_a_stream">10.4. Positioning in a stream</h3>
<div class="paragraph"><p>The <code>take</code> function from <code>Parsers.CONFIG</code> must return the position along with
the token. Most use cases will require the position as the location in the source
text presented as the conventional line + column numbers. Others will prefer a
simpler offset from the beginning of the stream. Others may even have more
specialized requirements.</p></div>
<div class="paragraph"><p>The stream implementations proposed in the library cannot implement each of those
and therefore they return no position (or rather: a unit value). Those
implementations can then be wrapped into another function that will compute
and overwrite the position.</p></div>
<div class="paragraph"><p>Again, we need those wrapper to be pure from side effects as we may read the
stream several times ; thus we cannot hide the required state in a closure.
Instead we add the positioner state to the stream type.</p></div>
<div class="paragraph"><p>The simplest such wrapper function, that works for every type of token, just
adds the offset from the beginning of the stream:</p></div>
<div class="listingblock">
<div class="title">ParsersPositions.ml: pairing an offset with every token</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">Batteries</span>
<span style="font-weight: bold"><span style="color: #000080">open</span></span> <span style="color: #009900">ParsersMisc</span>
<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">Offset</span> <span style="color: #990000">(</span><span style="color: #009900">Conf</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000080">Parsers</span></span><span style="color: #990000">.</span><span style="color: #009900">CONFIG</span> <span style="color: #990000">)</span>
  <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000080">Parsers</span></span><span style="color: #990000">.</span><span style="color: #009900">CONFIG</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>token
                    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> position <span style="color: #990000">=</span> <span style="color: #009900">int</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> stream <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>stream <span style="color: #990000">*</span> <span style="color: #009900">int</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>ct <span style="color: #990000">=</span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">(* Include Conf but change the stream type *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>token
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_token <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>print_token
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>ct
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_bind <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>ct_bind
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_return <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>ct_return
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> position <span style="color: #990000">=</span> <span style="color: #009900">int</span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> stream <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>stream <span style="color: #990000">*</span> position

  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> distance pos1 pos2 <span style="color: #990000">=</span> pos2 <span style="color: #990000">-</span> pos1
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_position fmt ofs <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"offset %d"</span> ofs
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_stream fmt <span style="color: #990000">(</span>str<span style="color: #990000">,</span> _<span style="color: #990000">)</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>print_stream fmt str
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> take <span style="color: #990000">(</span>stream<span style="color: #990000">,</span> pos<span style="color: #990000">)</span> <span style="color: #990000">=</span>
    ct_bind <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>take stream<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
      <span style="color: #990000">|</span> _<span style="color: #990000">,</span> <span style="color: #009900">Item</span> tok<span style="color: #990000">,</span> stream' <span style="color: #990000">-&gt;</span>
        ct_return <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> <span style="color: #009900">Item</span> tok<span style="color: #990000">,</span> <span style="color: #990000">(</span>stream'<span style="color: #990000">,</span> pos<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">))</span>
      <span style="color: #990000">|</span> _<span style="color: #990000">,</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> stream' <span style="color: #990000">-&gt;</span>
        ct_return <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> <span style="color: #990000">(</span>stream'<span style="color: #990000">,</span> pos<span style="color: #990000">)))</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream_of_string str <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>stream_of_string str<span style="color: #990000">,</span> <span style="color: #993399">0</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Another simple wrapper keeping track of the position as number of lines and
columns must sneak at the obtained tokens (looking for newlines) and
therefore works only with streams of characters:</p></div>
<div class="paragraph"><p>TODO:
1. Parsers.CONFIG should have a function to turn a string into a stream.
2. We should have a user-manual or a few simple easy functor for the end users.</p></div>
<div class="listingblock">
<div class="title">ParsersPositions.ml: pairing a line number and column number with every characters</div>
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">type</span></span> file_position <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> offs <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="color: #990000">;</span> line <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="color: #990000">;</span> column <span style="color: #990000">:</span> <span style="color: #009900">int</span> <span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">module</span></span> <span style="color: #009900">LineCol</span> <span style="color: #990000">(</span><span style="color: #009900">Conf</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000080">Parsers</span></span><span style="color: #990000">.</span><span style="color: #009900">CONFIG</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="color: #009900">char</span><span style="color: #990000">)</span>
  <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000080">Parsers</span></span><span style="color: #990000">.</span><span style="color: #009900">CONFIG</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>token
                    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> position <span style="color: #990000">=</span> file_position
                    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> stream <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>stream <span style="color: #990000">*</span> file_position
                    <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>ct <span style="color: #990000">=</span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">(* Include Conf but change the stream type *)</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> token <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>token
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_token <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>print_token
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> 'a ct <span style="color: #990000">=</span> 'a <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>ct
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_bind <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>ct_bind
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> ct_return <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>ct_return
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> position <span style="color: #990000">=</span> file_position
  <span style="font-weight: bold"><span style="color: #0000FF">type</span></span> stream <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>stream <span style="color: #990000">*</span> position

  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> distance pos1 pos2 <span style="color: #990000">=</span> pos2<span style="color: #990000">.</span>offs <span style="color: #990000">-</span> pos1<span style="color: #990000">.</span>offs
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_position fmt pos <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #000080">Printf</span></span><span style="color: #990000">.</span>fprintf fmt <span style="color: #FF0000">"line %d, col %d"</span> pos<span style="color: #990000">.</span>line pos<span style="color: #990000">.</span>column
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> print_stream fmt <span style="color: #990000">(</span>str<span style="color: #990000">,</span> _<span style="color: #990000">)</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>print_stream fmt str
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> take <span style="color: #990000">(</span>stream<span style="color: #990000">,</span> pos<span style="color: #990000">)</span> <span style="color: #990000">=</span>
    ct_bind <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>take stream<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span>
      <span style="color: #990000">|</span> _<span style="color: #990000">,</span> <span style="color: #009900">Item</span> tok<span style="color: #990000">,</span> stream' <span style="color: #990000">-&gt;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> line<span style="color: #990000">,</span> column <span style="color: #990000">=</span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> tok <span style="color: #990000">=</span> '<span style="color: #990000">\</span>n' <span style="font-weight: bold"><span style="color: #0000FF">then</span></span> <span style="color: #990000">(</span>pos<span style="color: #990000">.</span>line<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>
          <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #990000">(</span>pos<span style="color: #990000">.</span>line<span style="color: #990000">,</span> pos<span style="color: #990000">.</span>column<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> pos' <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> offs <span style="color: #990000">=</span> pos<span style="color: #990000">.</span>offs <span style="color: #990000">+</span> <span style="color: #993399">1</span> <span style="color: #990000">;</span> line <span style="color: #990000">;</span> column <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        ct_return <span style="color: #990000">(</span>pos'<span style="color: #990000">,</span> <span style="color: #009900">Item</span> tok<span style="color: #990000">,</span> <span style="color: #990000">(</span>stream'<span style="color: #990000">,</span> pos'<span style="color: #990000">))</span>
      <span style="color: #990000">|</span> _<span style="color: #990000">,</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> stream' <span style="color: #990000">-&gt;</span>
        ct_return <span style="color: #990000">(</span>pos<span style="color: #990000">,</span> <span style="color: #009900">EndOfStream</span><span style="color: #990000">,</span> <span style="color: #990000">(</span>stream'<span style="color: #990000">,</span> pos<span style="color: #990000">)))</span>
  <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> stream_of_string str <span style="color: #990000">=</span>
    <span style="font-weight: bold"><span style="color: #0000FF">let</span></span> start_pos <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> offs <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #990000">;</span> line <span style="color: #990000">=</span> <span style="color: #993399">1</span> <span style="color: #990000">;</span> column <span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
    <span style="font-weight: bold"><span style="color: #000080">Conf</span></span><span style="color: #990000">.</span>stream_of_string str<span style="color: #990000">,</span> start_pos
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Version 0.1<br />
Last updated
 2019-12-25 10:48:08 CET
</div>
</div>
</body>
</html>
